App As appinfo:
    BackEnabled: =false
    OnStart: |+
        =//Lấy tất cả user và role về
        //role: 1 employee, 2 quản lý trực tiếp, 3 giàm đốc khối, 4 giám đốc điều hành, 5 HR/C&B, 7 admin
        Collect(
            gblColAllUser,
            AddColumns(
                ShowColumns('ASTakeLeave.Users', "ID", "userID", "fullName", "shortName", "email", "phone", "jobTitle", "departmentID", "divisionID", "OData__x0033_65AccountInfo", "active") As temp, 
                "roleID", 
                LookUp(Filter('ASTakeLeave.Users_Roles',active = 1), userID = temp.userID).roleID
            )
        );
        
        //Lấy thông tin user hiện tại
        Set(
            gblRecUser,
            LookUp(gblColAllUser, email = User().Email)
        );
        
        //Start concurrent  ------------------------------------------------------------------
        Concurrent(
        
        //Lấy ra userInfo từ acc365
        ForAll(
            gblColAllUser As temp,
            Collect(
                gblColAllUser365,
                temp.OData__x0033_65AccountInfo
            )
        ),
        
        //Lấy tất cả phòng về
        Collect(
            gblColDepartment,
            ShowColumns('ASTakeLeave.Department', "ID", "name", "divisionID", "active")
        ),
        
        //Lấy tất cả khối về
        Collect(
            gblColDivision,
            ShowColumns('ASTakeLeave.Division', "ID", "name", "directorUserID", "active")
        ),
        
        //Lấy các cấp phê duyệt của user
        Switch(
            gblRecUser.roleID,
            1, 
            Collect(gblColUserManager, Filter('ASTakeLeave.UserRelationship', userID = gblRecUser.userID, active = 1)),
            2,
            Collect(gblColUserManager, Filter('ASTakeLeave.UserRelationship', userID = gblRecUser.userID, active = 1))
        ),
        //Lấy các cấp phê duyệt cấp cao
        Collect(gblColManagerHighLevel,Filter('ASTakeLeave.CommonRelationship',active = 1));
        
        //Lấy danh sách user quản lý theo role (Chỉ role manager và HR manager)
        If(
            gblRecUser.roleID = 2 || gblRecUser.roleID = 7,
            Collect(
                gblColUserBelong,
                Filter(
                    'ASTakeLeave.UserRelationship', approveUserID = gblRecUser.userID, approveProcessLevel = 1, active = 1
                )
            )
        ),
        
        //Lấy bảng lịch làm việc
        Collect(gblColWeekDay,'ASTakeLeave.WeekDay'),
        //Lấy bảng lịch ngày lễ
        Collect(gblColHoliday,'ASTakeLeave.Holiday');
        
        );
        //End concurent     -------------------------------------------------------------
        
    StartScreen: =If(LookUp('ASTakeLeave.Users_Roles',userID = LookUp('ASTakeLeave.Users','365AccountInfo'.Email = User().Email And active = 1).userID And active = 1).roleID = 1,'Home User Screen',LookUp('ASTakeLeave.Users_Roles',userID = LookUp('ASTakeLeave.Users','365AccountInfo'.Email = User().Email).userID).roleID = 6,'User Screen','Home Manager Screen')
    Theme: =PowerAppsTheme

    Host As hostControl.DefaultHostControlVariant:
        OnCancel: =false
        OnEdit: =false
        OnNew: =false
        OnSave: =false
        OnView: =false

