"'Request Screen' As screen":
    Fill: =RGBA(80,80,80,1)
    OnHidden: =
    OnVisible: |
        =//Tạo biến tổng ngày phép và ngày phép còn lại
        UpdateContext({locMaxDayLeaveNumber:LookUp('ASTakeLeave.TotalDayOffInYear',userID = gblRecUser.userID).maxDayOff_Year});
        UpdateContext({locTotalDayLeaveNumber:LookUp('ASTakeLeave.TotalDayOffInYear',userID = gblRecUser.userID).totalDayOff_Year});
        
        //Tạo collect chứa gồm 2 ngày bắt đầu và kết thúc của kì nghỉ
        ClearCollect(
            colDateRange,
            Table(
                {
                    ID: 1,
                    Date: dtp_rs_StartDay.SelectedDate,
                    Status: 1,
                    WeekDay: Weekday(dtp_rs_StartDay.SelectedDate)
                },
                {
                    ID: 2,
                    Date: dtp_rs_FinishDay.SelectedDate,
                    Status: 1,
                    WeekDay: Weekday(dtp_rs_FinishDay.SelectedDate)
                }
            )
        );
        UpdateContext({locRequestDayLeaveReverse: false});
        //Từng ngày phép trong tháng
        ClearCollect(
            colLeaveDayInMonth,
            AddColumns(
                Sequence(
                    12,
                    1
                ) As Temp,
                "LeaveDays",
                LookUp(
                    'ASTakeLeave.TotalDayOffInYear',
                    userID = gblRecUser.userID
                ).maxDayOff_Year / 12,
                "Status",
                If(CountRows(Filter('ASTakeLeave.LeaveRequest',userID = gblRecUser.userID And Month(startDate) = Temp.Value And status = 2)) = 1,1,0)
            )
        );
        //Kiểm tra ngày nghỉ
        If(
                locRequestDayLeaveReverse = false,
                If(
            //Kiểm tra tổng ngày nghỉ <= 2
                    Sum(colTotalListDateRange,Total) <= 2,
                    If(
                        DateDiff(
                            Today(),
                            dtp_rs_StartDay.SelectedDate
                        ) < 1,
                        UpdateContext({locShowErrorDate: "Phải tạo trước ít nhất 1 ngày làm việc"}),
                        UpdateContext({locShowErrorDate: "Ngày tạo hợp lệ"})
                    ),
            //Kiểm tra tổng ngày nghỉ >= 3 và <=4
                    Sum(colTotalListDateRange,Total) > 2 And Sum(colTotalListDateRange,Total) <= 4,
                    If(
                        DateDiff(
                            Today(),
                            dtp_rs_StartDay.SelectedDate
                        ) < 7,
                        UpdateContext({locShowErrorDate: "Phải tạo trước ít nhất 7 ngày làm việc"}),
                        UpdateContext({locShowErrorDate: "Ngày tạo hợp lệ"})
                    ),
            //Kiểm tra tổng ngày nghỉ >= 5
                    Sum(colTotalListDateRange,Total) > 4,
                    If(
                        DateDiff(
                            Today(),
                            dtp_rs_StartDay.SelectedDate
                        ) < 14,
                        UpdateContext({locShowErrorDate: "Phải tạo trước ít nhất 14 ngày làm việc"}),
                        UpdateContext({locShowErrorDate: "Ngày tạo hợp lệ"})
                    )
                )
            );
        //Tính tổng ngày nghỉ
        ClearCollect(
            colTotalListDateRange,
            AddColumns(
                FirstN(
                    [
                        0,
                        1,
                        2,
                        3,
                        4,
                        5,
                        6,
                        7,
                        8,
                        9,
                        10,
                        11,
                        12,
                        13,
                        14,
                        15,
                        16,
                        17,
                        18,
                        19,
                        20,
                        21,
                        22,
                        23,
                        24,
                        25,
                        26,
                        27,
                        28,
                        29
                    ],
                    DateDiff(
                        dtp_rs_StartDay.SelectedDate,
                        dtp_rs_FinishDay.SelectedDate,
                        TimeUnit.Days
                    ) + 1
                ),
                "Total",
                //Kiểm tra ngày nghỉ
                If(
                    CountRows(
                        Filter(
                            gblColHoliday,
                            active = 1 And date = DateAdd(
                                dtp_rs_StartDay.SelectedDate,
                                Value,
                                TimeUnit.Days
                            )
                        )
                    ) = 1,
                    0,
                    //Kiểm tra ngày chủ nhật
                    If(
                        Weekday(
                            DateAdd(
                                dtp_rs_StartDay.SelectedDate,
                                Value,
                                TimeUnit.Days
                            )
                        ) = 1,
                        0,
                        //Kiểm tra lịch làm việc (1 ngày hay nửa ngày)
                        If(
                            LookUp(
                                gblColWeekDay,
                                active = 1 And sort = Weekday(
                                    DateAdd(
                                        dtp_rs_StartDay.SelectedDate,
                                        Value,
                                        TimeUnit.Days
                                    )
                                )
                            ).status = 1,
                            //Kiểm tra trạng thái ngày bắt đầu và kết thúc do người dùng chọn (cả ngày, nửa sáng, nửa chiều)
                            If(
                                CountRows(
                                    Filter(
                                        colDateRange,
                                        Date = DateAdd(
                                            dtp_rs_StartDay.SelectedDate,
                                            Value,
                                            TimeUnit.Days
                                        ) And Status = 2
                                    )
                                ) = 1,
                                0.5,
                                CountRows(
                                    Filter(
                                        colDateRange,
                                        Date = DateAdd(
                                            dtp_rs_StartDay.SelectedDate,
                                            Value,
                                            TimeUnit.Days
                                        ) And Status = 3
                                    )
                                ) = 1,
                                0.5,1
                            ),
                            0.5
                        )
                    )
                ),
                "Date",
                DateAdd(
                    dtp_rs_StartDay.SelectedDate,
                    Value,
                    TimeUnit.Days
                )
            )
        );
        //Tính tổng ngày nghỉ cho phép
        /*UpdateContext({locLeaveDayAllow:If(
            Month(Today()) < 9,
            If(
                Value(
                    Right(
                        Round(
                            Sum(
                                Filter(
                                    colLeaveDayInMonth,
                                    Value <= Month(Today()) Or Value = Month(Today()) + 1 Or Value = Month(Today()) + 2 Or Value = Month(Today()) + 3 And Status = 0
                                ),
                                LeaveDays
                            ),
                            1
                        ),
                        1
                    )
                ) < 5,
                Round(
                    Sum(
                        Filter(
                            colLeaveDayInMonth,
                            Value <= Month(Today()) Or Value = Month(Today()) + 1 Or Value = Month(Today()) + 2 Or Value = Month(Today()) + 3 And Status = 0
                        ),
                        LeaveDays
                    ),
                    0
                ) - LookUp(
                    'ASTakeLeave.TotalDayOffInYear',
                    userID = gblRecUser.userID
                ).totalDayOff_Year,
                Value(
                    Right(
                        Round(
                            Sum(
                                Filter(
                                    colLeaveDayInMonth,
                                    Value <= Month(Today()) Or Value = Month(Today()) + 1 Or Value = Month(Today()) + 2 Or Value = Month(Today()) + 3 And Status = 0
                                ),
                                LeaveDays
                            ),
                            1
                        ),
                        1
                    )
                ) >= 5,
                RoundUp(
                    Sum(
                        Filter(
                            colLeaveDayInMonth,
                            Value <= Month(Today()) Or Value = Month(Today()) + 1 Or Value = Month(Today()) + 2 Or Value = Month(Today()) + 3 And Status = 0
                        ),
                        LeaveDays
                    ),
                    0
                ) - LookUp(
                    'ASTakeLeave.TotalDayOffInYear',
                    userID = gblRecUser.userID
                ).totalDayOff_Year
            ),
            //Tháng hiện tại là tháng 9
            If(
                Value(
                    Right(
                        Round(
                            Sum(
                                Filter(colLeaveDayInMonth,Status = 0),
                                LeaveDays
                            ),
                            1
                        ),
                        1
                    )
                ) < 5,
                Round(
                    Sum(
                        Filter(colLeaveDayInMonth,Status = 0),
                        LeaveDays
                    ),
                    0
                ) - LookUp(
                    'ASTakeLeave.TotalDayOffInYear',
                    userID = gblRecUser.userID
                ).totalDayOff_Year,
                Value(
                    Right(
                        Round(
                            Sum(
                                Filter(colLeaveDayInMonth,Status = 0),
                                LeaveDays
                            ),
                            1
                        ),
                        1
                    )
                ) >= 5,
                RoundUp(
                    Sum(
                        Filter(colLeaveDayInMonth,Status = 0),
                        LeaveDays
                    ),
                    0
                ) - LookUp(
                    'ASTakeLeave.TotalDayOffInYear',
                    userID = gblRecUser.userID
                ).totalDayOff_Year
            )
        )})*/
        //Kiểm tra tổng ngày nghỉ cho phép
        ClearCollect(
            colMaxDayLeave,
            Table(
                {
                    DayLeave: locTotalDayLeaveNumber,
                    CurrentTotalDayLeave: locMaxDayLeaveNumber / 12 * Month(Today()),
                    MaxDayLeaveCurrent: (locMaxDayLeaveNumber / 12 * Month(Today())) - locTotalDayLeaveNumber + (3 * locMaxDayLeaveNumber / 12),
                    TotalDayLeaveAllow: If(Month(Today())<9,If(
                        Value(
                            Right(
                                RoundUp(
                                    (locMaxDayLeaveNumber / 12 * Month(Today())) - locTotalDayLeaveNumber + (3 * locMaxDayLeaveNumber / 12),
                                    1
                                ),
                                1
                            )
                        ) < 5,
                        Round(
                            (locMaxDayLeaveNumber / 12 * Month(Today())) - locTotalDayLeaveNumber + (3 * locMaxDayLeaveNumber / 12),
                            0
                        ),
                        Value(
                            Right(
                                RoundUp(
                                    (locMaxDayLeaveNumber / 12 * Month(Today())) - locTotalDayLeaveNumber + (3 * locMaxDayLeaveNumber / 12),
                                    1
                                ),
                                1
                            )
                        ) >= 5,
                        RoundUp(
                            (locMaxDayLeaveNumber / 12 * Month(Today())) - locTotalDayLeaveNumber + (3 * locMaxDayLeaveNumber / 12),
                            0
                        )
                    ),Month(Today())>=9,locMaxDayLeaveNumber - locTotalDayLeaveNumber)
                }
            )
        );

    btn_rs_BackGroundScreen As button:
        BorderStyle: =BorderStyle.None
        DisabledFill: =RGBA(241, 244, 250, 1)
        DisplayMode: =DisplayMode.Disabled
        Height: =768
        RadiusBottomLeft: =20
        RadiusBottomRight: =20
        RadiusTopLeft: =20
        RadiusTopRight: =20
        Text: =""
        Width: =1366
        ZIndex: =1

    ctn_rs_Title As groupContainer.verticalAutoLayoutContainer:
        DropShadow: =DropShadow.None
        Height: =41
        LayoutMode: =LayoutMode.Auto
        PaddingLeft: =30
        PaddingRight: =30
        Width: =1170
        X: =196
        Y: =104
        ZIndex: =20

        lbl_rs_Title As label:
            AlignInContainer: =AlignInContainer.Stretch
            Color: =RGBA(43, 54, 74, 1)
            FontWeight: =FontWeight.Bold
            Height: =41
            Size: =18
            Text: ="Tạo mới yêu cầu nghỉ phép"
            Width: =350
            X: =191
            Y: =101
            ZIndex: =1

        Toggle3 As toggleSwitch:
            AlignInContainer: =AlignInContainer.Center
            BorderStyle: =BorderStyle.None
            Default: =locRequestDayLeaveReverse
            FalseText: ="Bình thường"
            OnSelect: |-
                =UpdateContext({locRequestDayLeaveReverse:!locRequestDayLeaveReverse});
                If(locRequestDayLeaveReverse = true,UpdateContext({locShowErrorDate: ""}),If(
                        locRequestDayLeaveReverse = false,
                        If(
                    //Kiểm tra tổng ngày nghỉ <= 2
                            DateDiff(
                                dtp_rs_StartDay.SelectedDate,
                                dtp_rs_FinishDay.SelectedDate
                            ) + 1 <= 2,
                            If(
                                DateDiff(
                                    Today(),
                                    dtp_rs_StartDay.SelectedDate
                                ) < 1,
                                UpdateContext({locShowErrorDate: "Phải tạo trước ít nhất 1 ngày làm việc"}),
                                UpdateContext({locShowErrorDate: "Ngày tạo hợp lệ"})
                            ),
                    //Kiểm tra tổng ngày nghỉ >= 3 và <=4
                            DateDiff(
                                dtp_rs_StartDay.SelectedDate,
                                dtp_rs_FinishDay.SelectedDate
                            ) + 1 >= 3 And DateDiff(
                                dtp_rs_StartDay.SelectedDate,
                                dtp_rs_FinishDay.SelectedDate
                            ) + 1 <= 4,
                            If(
                                DateDiff(
                                    Today(),
                                    dtp_rs_StartDay.SelectedDate
                                ) < 7,
                                UpdateContext({locShowErrorDate: "Phải tạo trước ít nhất 7 ngày làm việc"}),
                                UpdateContext({locShowErrorDate: "Ngày tạo hợp lệ"})
                            ),
                    //Kiểm tra tổng ngày nghỉ >= 5
                            DateDiff(
                                dtp_rs_StartDay.SelectedDate,
                                dtp_rs_FinishDay.SelectedDate
                            ) + 1 >= 5,
                            If(
                                DateDiff(
                                    Today(),
                                    dtp_rs_StartDay.SelectedDate
                                ) < 14,
                                UpdateContext({locShowErrorDate: "Phải tạo trước ít nhất 14 ngày làm việc"}),
                                UpdateContext({locShowErrorDate: "Ngày tạo hợp lệ"})
                            )
                        )
                    ));
            ShowLabel: =false
            TrueText: ="Đặc biệt"
            Width: =165
            ZIndex: =2

        lbl_rs_DivisionTitle_3 As label:
            Align: =Align.Right
            Color: =RGBA(94, 94, 94, 1)
            FillPortions: =1
            FontWeight: =FontWeight.Bold
            Size: =15
            Text: |-
                ="Được nghỉ tối đa: " & First(colMaxDayLeave).TotalDayLeaveAllow
            ZIndex: =3

        lbl_rs_DivisionTitle_1 As label:
            Align: =Align.Right
            Color: =RGBA(94, 94, 94, 1)
            FontWeight: =FontWeight.Semibold
            Size: =15
            Text: |-
                ="Tổng đã nghỉ: " & locTotalDayLeaveNumber & "/" & locMaxDayLeaveNumber
            Width: =230
            ZIndex: =4

    btn_rs_BackGround As button:
        BorderStyle: =BorderStyle.None
        BorderThickness: =0.1
        DisabledFill: =RGBA(246, 245, 250, 1)
        DisplayMode: =DisplayMode.Disabled
        Height: =609
        RadiusBottomLeft: =0
        RadiusBottomRight: =0
        Text: =""
        Width: =1164
        X: =168
        Y: =159
        ZIndex: =22

    ctn_rs_MainContent As groupContainer.horizontalAutoLayoutContainer:
        DropShadow: =DropShadow.None
        Height: =606
        LayoutGap: =10
        LayoutMode: =LayoutMode.Auto
        PaddingBottom: =10
        PaddingLeft: =35
        PaddingRight: =35
        PaddingTop: =10
        Width: =1170
        X: =196
        Y: =159
        ZIndex: =23

        ctn_rs_Form As groupContainer.horizontalAutoLayoutContainer:
            DropShadow: =DropShadow.None
            Fill: =RGBA(255, 255, 255, 1)
            LayoutMinHeight: =100
            LayoutMinWidth: =250
            LayoutMode: =LayoutMode.Auto
            PaddingBottom: =10
            PaddingLeft: =10
            PaddingRight: =10
            PaddingTop: =10
            ZIndex: =5

            ctn_rs_FormDetail1 As groupContainer.verticalAutoLayoutContainer:
                DropShadow: =DropShadow.None
                LayoutAlignItems: =LayoutAlignItems.Stretch
                LayoutDirection: =LayoutDirection.Vertical
                LayoutGap: =10
                LayoutMinHeight: =100
                LayoutMinWidth: =250
                LayoutMode: =LayoutMode.Auto
                LayoutOverflowY: =LayoutOverflow.Scroll
                PaddingLeft: =10
                PaddingRight: =10
                ZIndex: =1

                ctn_rs_Reason As groupContainer.verticalAutoLayoutContainer:
                    AlignInContainer: =AlignInContainer.SetByContainer
                    DropShadow: =DropShadow.None
                    FillPortions: =0
                    Height: =100
                    LayoutAlignItems: =LayoutAlignItems.Stretch
                    LayoutDirection: =LayoutDirection.Vertical
                    LayoutMinHeight: =100
                    LayoutMinWidth: =250
                    LayoutMode: =LayoutMode.Auto
                    PaddingLeft: =2
                    PaddingRight: =2
                    ZIndex: =1

                    lbl_rs_ReasonTitle As label:
                        Color: =RGBA(94, 94, 94, 1)
                        FontWeight: =FontWeight.Semibold
                        Size: =15
                        Text: ="Các lí do nghỉ"
                        ZIndex: =1

                    drp_rs_Reason As dropdown:
                        BorderColor: =RGBA(0, 0, 0, 1)
                        BorderThickness: =1
                        Height: =50
                        Items: ='ASTakeLeave.LeaveReason'
                        ZIndex: =2

                ctn_rs_Detail As groupContainer.verticalAutoLayoutContainer:
                    AlignInContainer: =AlignInContainer.SetByContainer
                    DropShadow: =DropShadow.None
                    FillPortions: =0
                    Height: =100
                    LayoutAlignItems: =LayoutAlignItems.Stretch
                    LayoutDirection: =LayoutDirection.Vertical
                    LayoutMinHeight: =100
                    LayoutMinWidth: =250
                    LayoutMode: =LayoutMode.Auto
                    PaddingLeft: =2
                    PaddingRight: =2
                    ZIndex: =2

                    lbl_rs_DetailTitle As label:
                        Color: =RGBA(94, 94, 94, 1)
                        FontWeight: =FontWeight.Semibold
                        Size: =15
                        Text: ="Chi tiết"
                        ZIndex: =1

                    txt_rs_Detail As text:
                        BorderColor: =RGBA(0, 0, 0, 1)
                        BorderThickness: =1
                        Default: =""
                        DisabledColor: =RGBA(0, 0, 0, 1)
                        DisabledFill: =RGBA(255, 255, 255, 1)
                        Height: =50
                        HintText: ="Nhập chi tiết lí do"
                        ZIndex: =2

                ctn_rs_Function As groupContainer.verticalAutoLayoutContainer:
                    AlignInContainer: =AlignInContainer.SetByContainer
                    DropShadow: =DropShadow.None
                    FillPortions: =0
                    Height: =100
                    LayoutAlignItems: =LayoutAlignItems.Stretch
                    LayoutDirection: =LayoutDirection.Vertical
                    LayoutMinHeight: =100
                    LayoutMinWidth: =250
                    LayoutMode: =LayoutMode.Auto
                    PaddingLeft: =2
                    ZIndex: =3

                    lbl_rs_JobTitle As label:
                        Color: =RGBA(94, 94, 94, 1)
                        FontWeight: =FontWeight.Semibold
                        Size: =15
                        Text: ="Ngày bắt đầu"
                        ZIndex: =1

                    dtp_rs_StartDay As datepicker:
                        BorderColor: =If(dtp_rs_StartDay.SelectedDate > dtp_rs_FinishDay.SelectedDate,Color.Red,RGBA(0, 0, 0, 1))
                        BorderThickness: =1
                        DefaultDate: =Today() + 1
                        DisabledColor: =RGBA(0, 0, 0, 1)
                        DisabledFill: =RGBA(255, 255, 255, 1)
                        Height: =50
                        IconBackground: =RGBA(73, 113, 215, 1)
                        OnChange: |-
                            =//Tính tổng ngày nghỉ
                            ClearCollect(
                                colTotalListDateRange,
                                AddColumns(
                                    FirstN(
                                        [
                                            0,
                                            1,
                                            2,
                                            3,
                                            4,
                                            5,
                                            6,
                                            7,
                                            8,
                                            9,
                                            10,
                                            11,
                                            12,
                                            13,
                                            14,
                                            15,
                                            16,
                                            17,
                                            18,
                                            19,
                                            20,
                                            21,
                                            22,
                                            23,
                                            24,
                                            25,
                                            26,
                                            27,
                                            28,
                                            29
                                        ],
                                        DateDiff(
                                            dtp_rs_StartDay.SelectedDate,
                                            dtp_rs_FinishDay.SelectedDate,
                                            TimeUnit.Days
                                        ) + 1
                                    ),
                                    "Total",
                                    //Kiểm tra ngày nghỉ
                                    If(
                                        CountRows(
                                            Filter(
                                                gblColHoliday,
                                                active = 1 And date = DateAdd(
                                                    dtp_rs_StartDay.SelectedDate,
                                                    Value,
                                                    TimeUnit.Days
                                                )
                                            )
                                        ) = 1,
                                        0,
                                        //Kiểm tra ngày chủ nhật
                                        If(
                                            Weekday(
                                                DateAdd(
                                                    dtp_rs_StartDay.SelectedDate,
                                                    Value,
                                                    TimeUnit.Days
                                                )
                                            ) = 1,
                                            0,
                                            //Kiểm tra lịch làm việc (1 ngày hay nửa ngày)
                                            If(
                                                LookUp(
                                                    gblColWeekDay,
                                                    active = 1 And sort = Weekday(
                                                        DateAdd(
                                                            dtp_rs_StartDay.SelectedDate,
                                                            Value,
                                                            TimeUnit.Days
                                                        )
                                                    )
                                                ).status = 1,
                                                //Kiểm tra trạng thái ngày bắt đầu và kết thúc do người dùng chọn (cả ngày, nửa sáng, nửa chiều)
                                                If(
                                                    CountRows(
                                                        Filter(
                                                            colDateRange,
                                                            Date = DateAdd(
                                                                dtp_rs_StartDay.SelectedDate,
                                                                Value,
                                                                TimeUnit.Days
                                                            ) And Status = 2
                                                        )
                                                    ) = 1,
                                                    0.5,
                                                    CountRows(
                                                        Filter(
                                                            colDateRange,
                                                            Date = DateAdd(
                                                                dtp_rs_StartDay.SelectedDate,
                                                                Value,
                                                                TimeUnit.Days
                                                            ) And Status = 3
                                                        )
                                                    ) = 1,
                                                    0.5,
                                                    1
                                                ),
                                                0.5
                                            )
                                        )
                                    ),
                                    "Date",
                                    DateAdd(
                                        dtp_rs_StartDay.SelectedDate,
                                        Value,
                                        TimeUnit.Days
                                    )
                                )
                            );
                            If(
                                //Kiểm tra ngày kết thúc nhỏ hơn ngày bắt đầu
                                dtp_rs_StartDay.SelectedDate > dtp_rs_FinishDay.SelectedDate,
                                Notify(
                                    "Ngày kết thúc nhỏ hơn ngày bắt đầu",
                                    NotificationType.Error,
                                    1500
                                ),
                                //Cập nhật ngày bắt đâu vào danh sách trạng thái ngày nghỉ
                                Patch(
                                    colDateRange,
                                    LookUp(
                                        colDateRange,
                                        ID = 1
                                    ),
                                    {
                                        Date: dtp_rs_StartDay.SelectedDate,
                                        WeekDay: Weekday(dtp_rs_StartDay.SelectedDate)
                                    }
                                );
                                If(
                                    locRequestDayLeaveReverse = false,
                                    If(
                                //Kiểm tra tổng ngày nghỉ <= 2
                                        Sum(colTotalListDateRange,Total) <= 2,
                                        If(
                                            DateDiff(
                                                Today(),
                                                dtp_rs_StartDay.SelectedDate
                                            ) < 1,
                                            UpdateContext({locShowErrorDate: "Phải tạo trước ít nhất 1 ngày làm việc"}),
                                            UpdateContext({locShowErrorDate: "Ngày tạo hợp lệ"})
                                        ),
                                //Kiểm tra tổng ngày nghỉ >= 3 và <=4
                                        Sum(colTotalListDateRange,Total) > 2 And Sum(colTotalListDateRange,Total) <= 4,
                                        If(
                                            DateDiff(
                                                Today(),
                                                dtp_rs_StartDay.SelectedDate
                                            ) < 7,
                                            UpdateContext({locShowErrorDate: "Phải tạo trước ít nhất 7 ngày làm việc"}),
                                            UpdateContext({locShowErrorDate: "Ngày tạo hợp lệ"})
                                        ),
                                //Kiểm tra tổng ngày nghỉ >= 5
                                        Sum(colTotalListDateRange,Total) > 4,
                                        If(
                                            DateDiff(
                                                Today(),
                                                dtp_rs_StartDay.SelectedDate
                                            ) < 14,
                                            UpdateContext({locShowErrorDate: "Phải tạo trước ít nhất 14 ngày làm việc"}),
                                            UpdateContext({locShowErrorDate: "Ngày tạo hợp lệ"})
                                        )
                                    )
                                )
                            );
                        ZIndex: =3

                ctn_rs_Division As groupContainer.verticalAutoLayoutContainer:
                    AlignInContainer: =AlignInContainer.SetByContainer
                    DropShadow: =DropShadow.None
                    FillPortions: =0
                    Height: =100
                    LayoutAlignItems: =LayoutAlignItems.Stretch
                    LayoutDirection: =LayoutDirection.Vertical
                    LayoutMinHeight: =100
                    LayoutMinWidth: =250
                    LayoutMode: =LayoutMode.Auto
                    PaddingLeft: =2
                    ZIndex: =4

                    lbl_rs_DivisionTitle As label:
                        Color: =RGBA(94, 94, 94, 1)
                        FontWeight: =FontWeight.Semibold
                        Size: =15
                        Text: ="Ngày kết thúc"
                        ZIndex: =1

                    dtp_rs_FinishDay As datepicker:
                        BorderColor: =If(dtp_rs_FinishDay.SelectedDate < dtp_rs_StartDay.SelectedDate,Color.Red,RGBA(0, 0, 0, 1))
                        BorderThickness: =1
                        DefaultDate: =Today() + 1
                        DisabledColor: =RGBA(0, 0, 0, 1)
                        DisabledFill: =RGBA(255, 255, 255, 1)
                        Height: =50
                        IconBackground: =RGBA(73, 113, 215, 1)
                        OnChange: |-
                            =//Tính tổng ngày nghỉ
                            ClearCollect(
                                colTotalListDateRange,
                                AddColumns(
                                    FirstN(
                                        [
                                            0,
                                            1,
                                            2,
                                            3,
                                            4,
                                            5,
                                            6,
                                            7,
                                            8,
                                            9,
                                            10,
                                            11,
                                            12,
                                            13,
                                            14,
                                            15,
                                            16,
                                            17,
                                            18,
                                            19,
                                            20,
                                            21,
                                            22,
                                            23,
                                            24,
                                            25,
                                            26,
                                            27,
                                            28,
                                            29
                                        ],
                                        DateDiff(
                                            dtp_rs_StartDay.SelectedDate,
                                            dtp_rs_FinishDay.SelectedDate,
                                            TimeUnit.Days
                                        ) + 1
                                    ),
                                    "Total",
                                    //Kiểm tra ngày nghỉ
                                    If(
                                        CountRows(
                                            Filter(
                                                gblColHoliday,
                                                active = 1 And date = DateAdd(
                                                    dtp_rs_StartDay.SelectedDate,
                                                    Value,
                                                    TimeUnit.Days
                                                )
                                            )
                                        ) = 1,
                                        0,
                                        //Kiểm tra ngày chủ nhật
                                        If(
                                            Weekday(
                                                DateAdd(
                                                    dtp_rs_StartDay.SelectedDate,
                                                    Value,
                                                    TimeUnit.Days
                                                )
                                            ) = 1,
                                            0,
                                            //Kiểm tra lịch làm việc (1 ngày hay nửa ngày)
                                            If(
                                                LookUp(
                                                    gblColWeekDay,
                                                    active = 1 And sort = Weekday(
                                                        DateAdd(
                                                            dtp_rs_StartDay.SelectedDate,
                                                            Value,
                                                            TimeUnit.Days
                                                        )
                                                    )
                                                ).status = 1,
                                                //Kiểm tra trạng thái ngày bắt đầu và kết thúc do người dùng chọn (cả ngày, nửa sáng, nửa chiều)
                                                If(
                                                    CountRows(
                                                        Filter(
                                                            colDateRange,
                                                            Date = DateAdd(
                                                                dtp_rs_StartDay.SelectedDate,
                                                                Value,
                                                                TimeUnit.Days
                                                            ) And Status = 2
                                                        )
                                                    ) = 1,
                                                    0.5,
                                                    CountRows(
                                                        Filter(
                                                            colDateRange,
                                                            Date = DateAdd(
                                                                dtp_rs_StartDay.SelectedDate,
                                                                Value,
                                                                TimeUnit.Days
                                                            ) And Status = 3
                                                        )
                                                    ) = 1,
                                                    0.5,1
                                                ),
                                                0.5
                                            )
                                        )
                                    ),
                                    "Date",
                                    DateAdd(
                                        dtp_rs_StartDay.SelectedDate,
                                        Value,
                                        TimeUnit.Days
                                    )
                                )
                            );
                            If(
                                //Kiểm tra ngày kết thúc nhỏ hơn ngày bắt đầu
                                dtp_rs_FinishDay.SelectedDate < dtp_rs_StartDay.SelectedDate,
                                Notify(
                                    "Ngày kết thúc nhỏ hơn ngày bắt đầu",
                                    NotificationType.Error,
                                    1500
                                ),
                                //Cập nhật ngày bắt đâu vào danh sách trạng thái ngày nghỉ
                                Patch(
                                    colDateRange,
                                    LookUp(
                                        colDateRange,
                                        ID = 2
                                    ),
                                    {Date: dtp_rs_FinishDay.SelectedDate,WeekDay:Weekday(dtp_rs_FinishDay.SelectedDate)}
                                );
                                If(
                                    locRequestDayLeaveReverse = false,
                                    If(
                                //Kiểm tra tổng ngày nghỉ <= 2
                                        Sum(colTotalListDateRange,Total) <= 2,
                                        If(
                                            DateDiff(
                                                Today(),
                                                dtp_rs_StartDay.SelectedDate
                                            ) < 1,
                                            UpdateContext({locShowErrorDate: "Phải tạo trước ít nhất 1 ngày làm việc"}),
                                            UpdateContext({locShowErrorDate: "Ngày tạo hợp lệ"})
                                        ),
                                //Kiểm tra tổng ngày nghỉ >= 3 và <=4
                                        Sum(colTotalListDateRange,Total) > 2 And Sum(colTotalListDateRange,Total) <= 4,
                                        If(
                                            DateDiff(
                                                Today(),
                                                dtp_rs_StartDay.SelectedDate
                                            ) < 7,
                                            UpdateContext({locShowErrorDate: "Phải tạo trước ít nhất 7 ngày làm việc"}),
                                            UpdateContext({locShowErrorDate: "Ngày tạo hợp lệ"})
                                        ),
                                //Kiểm tra tổng ngày nghỉ >= 5
                                        Sum(colTotalListDateRange,Total) > 4,
                                        If(
                                            DateDiff(
                                                Today(),
                                                dtp_rs_StartDay.SelectedDate
                                            ) < 14,
                                            UpdateContext({locShowErrorDate: "Phải tạo trước ít nhất 14 ngày làm việc"}),
                                            UpdateContext({locShowErrorDate: "Ngày tạo hợp lệ"})
                                        )
                                    )
                                )
                            );
                        ZIndex: =2

                Label7 As label:
                    Color: =If(locShowErrorDate <> "Ngày tạo hợp lệ",RGBA(255, 0, 0, 1),Color.Green)
                    Height: =25
                    Text: =If(locRequestDayLeaveReverse = false And dtp_rs_StartDay.SelectedDate < Today(),"Chọn nghỉ phép ngược để tạo yêu cầu trước ngày hiện tại",locRequestDayLeaveReverse = true And dtp_rs_StartDay.SelectedDate > Today(),"Ngày nghỉ không hợp lệ",locShowErrorDate)
                    Visible: =If(IsBlank(Label7.Text),false,true)
                    ZIndex: =5

                ctn_rs_Division_1 As groupContainer.verticalAutoLayoutContainer:
                    AlignInContainer: =AlignInContainer.SetByContainer
                    DropShadow: =DropShadow.None
                    FillPortions: =0
                    Height: =150
                    LayoutAlignItems: =LayoutAlignItems.Stretch
                    LayoutDirection: =LayoutDirection.Vertical
                    LayoutMinHeight: =100
                    LayoutMinWidth: =250
                    LayoutMode: =LayoutMode.Auto
                    ZIndex: =6

                    Container3 As groupContainer.horizontalAutoLayoutContainer:
                        DropShadow: =DropShadow.None
                        FillPortions: =0
                        Height: =50
                        LayoutMinHeight: =100
                        LayoutMinWidth: =250
                        LayoutMode: =LayoutMode.Auto
                        ZIndex: =1

                        lbl_rs_DivisionTitle_2 As label:
                            Color: =RGBA(94, 94, 94, 1)
                            FillPortions: =1
                            FontWeight: =FontWeight.Semibold
                            Height: =50
                            Size: =15
                            Text: |-
                                ="Tổng: " & Sum(colTotalListDateRange,Total) & " ngày " & If(Sum(colTotalListDateRange,Total) > First(colMaxDayLeave).TotalDayLeaveAllow,"(tổng ngày nghỉ lớn hơn ngày nghỉ cho phép)")
                            ZIndex: =2

                    Gallery5 As gallery.galleryHorizontal:
                        DelayItemLoading: =true
                        FillPortions: =0
                        Height: =100
                        Items: =If(dtp_rs_StartDay.SelectedDate = dtp_rs_FinishDay.SelectedDate,Filter(colDateRange,ID = 1),colDateRange)
                        LayoutMinHeight: =287
                        LayoutMinWidth: =320
                        LoadingSpinner: =LoadingSpinner.Data
                        ShowScrollbar: =false
                        TemplateSize: =150
                        ZIndex: =4

                        Button9 As button:
                            BorderThickness: =1
                            Color: =
                            DisabledColor: =RGBA(255, 255, 255, 1)
                            DisabledFill: =RGBA(73, 113, 215, 1)
                            DisplayMode: =DisplayMode.Disabled
                            FontWeight: =FontWeight.Bold
                            Height: =90
                            OnSelect: =Select(Parent)
                            PaddingBottom: =If(ThisItem.WeekDay = 1 Or CountRows(Filter(gblColHoliday,active = 1 And date = ThisItem.Date)) = 1,0,55)
                            RadiusBottomLeft: =5
                            RadiusBottomRight: =5
                            RadiusTopLeft: =5
                            RadiusTopRight: =5
                            Size: =12
                            Text: =ThisItem.Date
                            Width: =147
                            ZIndex: =1

                        Dropdown1 As dropdown:
                            BorderColor: =Color.White
                            BorderThickness: =1
                            Default: |-
                                =If(LookUp(gblColWeekDay,active = 1 And sort = ThisItem.WeekDay).status = 1,LookUp(Table({ID:1,Name:"Cả ngày"},{ID:2,Name:"Nửa sáng"},{ID:3,Name:"Nửa chiều"}),ID = ThisItem.Status).Name,LookUp(gblColWeekDay,active = 1 And sort = ThisItem.WeekDay).status = 2,LookUp(Table({ID:2,Name:"Nửa sáng"},{ID:3,Name:"Nửa chiều"}),ID = ThisItem.Status).Name)
                            DisabledColor: =RGBA(0, 0, 0, 1)
                            DisabledFill: =RGBA(255, 255, 255, 1)
                            Height: =31
                            Items: |-
                                =If(LookUp(gblColWeekDay,active = 1 And sort = ThisItem.WeekDay).status = 1,Table({ID:1,Name:"Cả ngày"},{ID:2,Name:"Nửa sáng"},{ID:3,Name:"Nửa chiều"}),LookUp(gblColWeekDay,active = 1 And sort = ThisItem.WeekDay).status = 2,Table({ID:2,Name:"Nửa sáng"},{ID:3,Name:"Nửa chiều"}))
                            OnChange: |-
                                =Patch(colDateRange,LookUp(colDateRange,ID = ThisItem.ID),{Status:Dropdown1.Selected.ID});
                                //Tính tổng ngày nghỉ
                                ClearCollect(
                                    colTotalListDateRange,
                                    AddColumns(
                                        FirstN(
                                            [
                                                0,
                                                1,
                                                2,
                                                3,
                                                4,
                                                5,
                                                6,
                                                7,
                                                8,
                                                9,
                                                10,
                                                11,
                                                12,
                                                13,
                                                14,
                                                15,
                                                16,
                                                17,
                                                18,
                                                19,
                                                20,
                                                21,
                                                22,
                                                23,
                                                24,
                                                25,
                                                26,
                                                27,
                                                28,
                                                29
                                            ],
                                            DateDiff(
                                                dtp_rs_StartDay.SelectedDate,
                                                dtp_rs_FinishDay.SelectedDate,
                                                TimeUnit.Days
                                            ) + 1
                                        ),
                                        "Total",
                                        //Kiểm tra ngày nghỉ
                                        If(
                                            CountRows(
                                                Filter(
                                                    gblColHoliday,
                                                    active = 1 And date = DateAdd(
                                                        dtp_rs_StartDay.SelectedDate,
                                                        Value,
                                                        TimeUnit.Days
                                                    )
                                                )
                                            ) = 1,
                                            0,
                                            //Kiểm tra ngày chủ nhật
                                            If(
                                                Weekday(
                                                    DateAdd(
                                                        dtp_rs_StartDay.SelectedDate,
                                                        Value,
                                                        TimeUnit.Days
                                                    )
                                                ) = 1,
                                                0,
                                                //Kiểm tra lịch làm việc (1 ngày hay nửa ngày)
                                                If(
                                                    LookUp(
                                                        gblColWeekDay,
                                                        active = 1 And sort = Weekday(
                                                            DateAdd(
                                                                dtp_rs_StartDay.SelectedDate,
                                                                Value,
                                                                TimeUnit.Days
                                                            )
                                                        )
                                                    ).status = 1,
                                                    //Kiểm tra trạng thái ngày bắt đầu và kết thúc do người dùng chọn (cả ngày, nửa sáng, nửa chiều)
                                                    If(
                                                        CountRows(
                                                            Filter(
                                                                colDateRange,
                                                                Date = DateAdd(
                                                                    dtp_rs_StartDay.SelectedDate,
                                                                    Value,
                                                                    TimeUnit.Days
                                                                ) And Status = 2
                                                            )
                                                        ) = 1,
                                                        0.5,
                                                        CountRows(
                                                            Filter(
                                                                colDateRange,
                                                                Date = DateAdd(
                                                                    dtp_rs_StartDay.SelectedDate,
                                                                    Value,
                                                                    TimeUnit.Days
                                                                ) And Status = 3
                                                            )
                                                        ) = 1,
                                                        0.5,1
                                                    ),
                                                    0.5
                                                )
                                            )
                                        ),
                                        "Date",
                                        DateAdd(
                                            dtp_rs_StartDay.SelectedDate,
                                            Value,
                                            TimeUnit.Days
                                        )
                                    )
                                )
                            OnSelect: =Select(Parent)
                            PaddingBottom: =5
                            PaddingLeft: =5
                            PaddingRight: =5
                            PaddingTop: =5
                            Size: =12
                            Visible: =If(ThisItem.WeekDay = 1 Or CountRows(Filter(gblColHoliday,active = 1 And date = ThisItem.Date)) = 1,false,true)
                            Width: =137
                            X: =5
                            Y: =47
                            ZIndex: =2

            ctn_rs_FormDetail2 As groupContainer.verticalAutoLayoutContainer:
                DropShadow: =DropShadow.None
                LayoutAlignItems: =LayoutAlignItems.Stretch
                LayoutDirection: =LayoutDirection.Vertical
                LayoutGap: =10
                LayoutMinHeight: =100
                LayoutMinWidth: =250
                LayoutMode: =LayoutMode.Auto
                PaddingBottom: =48
                PaddingLeft: =10
                PaddingRight: =10
                ZIndex: =2

                ctn_rs_HandOverContent As groupContainer.verticalAutoLayoutContainer:
                    AlignInContainer: =AlignInContainer.SetByContainer
                    DropShadow: =DropShadow.None
                    LayoutAlignItems: =LayoutAlignItems.Stretch
                    LayoutDirection: =LayoutDirection.Vertical
                    LayoutMinHeight: =100
                    LayoutMinWidth: =250
                    LayoutMode: =LayoutMode.Auto
                    PaddingLeft: =10
                    PaddingRight: =10
                    ZIndex: =1

                    ctn_rs_HandOver As groupContainer.verticalAutoLayoutContainer:
                        AlignInContainer: =AlignInContainer.SetByContainer
                        DropShadow: =DropShadow.None
                        FillPortions: =0
                        Height: =100
                        LayoutAlignItems: =LayoutAlignItems.Stretch
                        LayoutDirection: =LayoutDirection.Vertical
                        LayoutMinHeight: =100
                        LayoutMinWidth: =250
                        LayoutMode: =LayoutMode.Auto
                        PaddingLeft: =1
                        ZIndex: =1

                        lbl_rs_HandOverTitle As label:
                            Color: =RGBA(94, 94, 94, 1)
                            FontWeight: =FontWeight.Semibold
                            Size: =15
                            Text: ="Công việc bàn giao cho"
                            ZIndex: =1

                        drp_rs_HandOver As combobox:
                            BorderColor: =RGBA(0, 0, 0, 1)
                            BorderThickness: =1
                            DisplayFields: =["DisplayName","Email","Picture"]
                            Height: =50
                            InputTextPlaceholder: ="Tìm nhân viên"
                            IsSearchable: =false
                            Items: =Filter(gblColAllUser365,Email <> User().Email)
                            SearchFields: =["Claims"]
                            SearchItems: =[]
                            SelectMultiple: =false
                            Template: =ListItemTemplate.Person
                            ZIndex: =3

                    lbl_rs_HandOverContentTitle As label:
                        Color: =RGBA(94, 94, 94, 1)
                        FontWeight: =FontWeight.Semibold
                        Size: =15
                        Text: ="Nội dung bàn giao"
                        ZIndex: =2

                    txt_rs_HandOverContent As text:
                        BorderColor: =RGBA(0, 0, 0, 1)
                        BorderThickness: =1
                        Default: =""
                        DisabledColor: =RGBA(0, 0, 0, 1)
                        DisabledFill: =RGBA(255, 255, 255, 1)
                        DisplayMode: =If(!IsBlank(drp_rs_HandOver.Selected.Email),DisplayMode.Edit,DisplayMode.Disabled)
                        Height: =169
                        HintText: ="Nhập nội dung bàn giao"
                        Mode: =TextMode.MultiLine
                        PaddingTop: =10
                        ZIndex: =3

                    Form2 As form:
                        DataSource: ='ASTakeLeave.LeaveRequest'
                        DefaultMode: =FormMode.New
                        FillPortions: =0
                        Height: =220
                        LayoutMinHeight: =250
                        LayoutMinWidth: =400
                        ZIndex: =4

                        Attachments_DataCard3 As typedDataCard.attachmentsEditCard:
                            BorderStyle: =BorderStyle.Solid
                            DataField: ="{Attachments}"
                            Default: =ThisItem.Attachments
                            DisplayMode: =Parent.DisplayMode
                            DisplayName: ="Đính kèm"
                            Fill: =RGBA(0, 0, 0, 0)
                            Height: =100
                            Required: =false
                            Update: =DataCardValue2.Attachments
                            Width: =500
                            X: =0
                            Y: =0
                            ZIndex: =1

                            DataCardKey2 As label:
                                AutoHeight: =true
                                Color: =RGBA(94, 94, 94, 1)
                                FontWeight: =FontWeight.Semibold
                                Height: =34
                                Size: =15
                                Text: =Parent.DisplayName
                                Width: =146
                                Wrap: =false
                                X: =1
                                Y: =3
                                ZIndex: =1

                            DataCardValue2 As attachments:
                                AddAttachmentText: ="Nhấn để thêm file"
                                BorderColor: =RGBA(0, 0, 0, 1)
                                BorderThickness: =1
                                DisplayMode: =Parent.DisplayMode
                                Height: =103
                                IsInDataCard: =true
                                Items: =Parent.Default
                                MaxAttachmentsText: ="Số lượng file đạt tối đa."
                                NoAttachmentsText: ="Không có tệp được đính kèm."
                                PaddingBottom: =5
                                PaddingLeft: =If(Self.DisplayMode = DisplayMode.Edit, 5, 0)
                                PaddingRight: =5
                                PaddingTop: =5
                                Tooltip: =Parent.DisplayName
                                Width: =498
                                X: =1
                                Y: =DataCardKey2.Y + DataCardKey2.Height + 5
                                ZIndex: =2

                            ErrorMessage2 As label:
                                AutoHeight: =true
                                Height: =10
                                Live: =Live.Assertive
                                PaddingBottom: =0
                                PaddingLeft: =0
                                PaddingRight: =0
                                PaddingTop: =0
                                Text: =Parent.Error
                                Visible: =Parent.DisplayMode=DisplayMode.Edit
                                Width: =Parent.Width - 60
                                X: =30
                                Y: =DataCardValue2.Y + DataCardValue2.Height
                                ZIndex: =3

                            StarVisible2 As label:
                                Align: =Align.Center
                                Height: =DataCardKey2.Height
                                Text: ="*"
                                Visible: =And(Parent.Required, Parent.DisplayMode=DisplayMode.Edit)
                                Width: =30
                                Wrap: =false
                                Y: =DataCardKey2.Y
                                ZIndex: =4

                btn_rs_Submit As button:
                    AlignInContainer: =AlignInContainer.End
                    Fill: =RGBA(73, 113, 215, 1)
                    OnSelect: |-
                        =If(
                            dtp_rs_StartDay.SelectedDate > dtp_rs_FinishDay.SelectedDate,
                            Notify(
                                "Ngày bắt đầu không được lớn hơn ngày kết thúc",
                                NotificationType.Error,
                                1500
                            ),
                            dtp_rs_FinishDay.SelectedDate < dtp_rs_StartDay.SelectedDate,
                            Notify(
                                "Ngày kết thúc không được nhỏ hơn ngày bắt đầu",
                                NotificationType.Error,
                                1500
                            ),
                            IsBlank(txt_rs_Detail.Text),
                            Notify(
                                "Trường chi tiết nghỉ phép không được bỏ trống",
                                NotificationType.Error,
                                1500
                            ),
                            Sum(
                                colTotalListDateRange,
                                Total
                            ) = 0,
                            Notify(
                                "Ngày nghỉ phải lớn hơn hoặc bằng 1 ngày",
                                NotificationType.Error,
                                1500
                            ),
                            Sum(
                                colTotalListDateRange,
                                Total
                            ) > First(colMaxDayLeave).TotalDayLeaveAllow,
                            Notify(
                                "Tổng ngày nghỉ lớn hơn ngày nghỉ cho phép",
                                NotificationType.Error,
                                1500
                            ),
                            locRequestDayLeaveReverse = false And dtp_rs_StartDay.SelectedDate < Today(),
                            Notify(
                                "Chọn nghỉ phép ngược để tạo yêu cầu trước ngày hiện tại",
                                NotificationType.Error,
                                1500
                            ),
                            locRequestDayLeaveReverse = true And dtp_rs_StartDay.SelectedDate > Today(),
                            Notify(
                                "Ngày tạo không hợp lệ",
                                NotificationType.Error,
                                1500
                            ),
                            locRequestDayLeaveReverse = false And locShowErrorDate <> "Ngày tạo hợp lệ",
                            Notify(
                                "Ngày tạo không hợp lệ",
                                NotificationType.Error,
                                1500
                            ),
                            Clear(colDayLeft);
                            Clear(colRecordTotalDayLeaveByMonthCalculated);
                            ClearCollect(
                                colRecordTotalDayLeaveByMonth,
                                AddColumns(
                                    Sequence(
                                        12,
                                        1
                                    ) As Temp,
                                    "TotalLeaveDay",
                                    If(
                                        IsBlank(
                                            Sum(
                                                Filter(
                                                    colTotalListDateRange,
                                                    Month(Date) = Temp.Value
                                                ),
                                                Total
                                            )
                                        ),
                                        0,
                                        Sum(
                                            Filter(
                                                colTotalListDateRange,
                                                Month(Date) = Temp.Value
                                            ),
                                            Total
                                        )
                                    )
                                )
                            );
                            ForAll(
                                Filter(
                                    colRecordTotalDayLeaveByMonth,
                                    TotalLeaveDay > 0
                                ) As Temp,
                                Collect(
                                    colDayLeft,
                                    Table(
                                        {
                                            Result: If(
                                                Temp.Value = First(
                                                    Filter(
                                                        colRecordTotalDayLeaveByMonth,
                                                        TotalLeaveDay > 0
                                                    )
                                                ).Value,
                                                locMaxDayLeaveNumber - Temp.TotalLeaveDay,
                                                Last(colDayLeft).Result - Temp.TotalLeaveDay
                                            )
                                        }
                                    )
                                );
                                Collect(
                                    colRecordTotalDayLeaveByMonthCalculated,
                                    Table(
                                        {
                                            Month: Temp.Value,
                                            TotalLeaveDay: Temp.TotalLeaveDay,
                                            TotalLeaveUnpaid: If(
                                                Last(colDayLeft).Result < 0,
                                                Mid(
                                                    Last(colDayLeft).Result,
                                                    2
                                                ),
                                                0
                                            )
                                        }
                                    )
                                )
                            );
                            UpdateContext({locSubmit: true});
                            /*ClearCollect(
                                colListDateRange,
                                AddColumns(
                                    FirstN(
                                        [
                                            0,
                                            1,
                                            2,
                                            3,
                                            4,
                                            5,
                                            6,
                                            7,
                                            8,
                                            9,
                                            10,
                                            11,
                                            12,
                                            13,
                                            14,
                                            15,
                                            16,
                                            17,
                                            18,
                                            19,
                                            20,
                                            21,
                                            22,
                                            23,
                                            24,
                                            25,
                                            26,
                                            27,
                                            28,
                                            29
                                        ],
                                        DateDiff(
                                            dtp_rs_StartDay.SelectedDate,
                                            dtp_rs_FinishDay.SelectedDate,
                                            TimeUnit.Days
                                        ) + 1
                                    ),
                                    "Total",
                                    If(
                                        CountRows(
                                            Filter(
                                                gblColHoliday,
                                                active = 1 And date = DateAdd(
                                                    dtp_rs_StartDay.SelectedDate,
                                                    Value,
                                                    TimeUnit.Days
                                                )
                                            )
                                        ) = 1,
                                        0,
                                        If(
                                            Weekday(
                                                DateAdd(
                                                    dtp_rs_StartDay.SelectedDate,
                                                    Value,
                                                    TimeUnit.Days
                                                )
                                            ) = 1,
                                            0,
                                            If(
                                                LookUp(
                                                    gblColWeekDay,
                                                    active = 1 And sort = Weekday(
                                                        DateAdd(
                                                            dtp_rs_StartDay.SelectedDate,
                                                            Value,
                                                            TimeUnit.Days
                                                        )
                                                    )
                                                ).status = 1,
                                                If(
                                                    CountRows(
                                                        Filter(
                                                            colDateRange,
                                                            Date = DateAdd(
                                                                dtp_rs_StartDay.SelectedDate,
                                                                Value,
                                                                TimeUnit.Days
                                                            ) And Status = 1
                                                        )
                                                    ) = 1,
                                                    LookUp(
                                                        'ASTakeLeave.TotalDayOffInYear',
                                                        userID = gblRecUser.userID
                                                    ).maxDayOff_Year / 12,
                                                    (LookUp(
                                                        'ASTakeLeave.TotalDayOffInYear',
                                                        userID = gblRecUser.userID
                                                    ).maxDayOff_Year / 12) / 2
                                                ),
                                                (LookUp(
                                                    'ASTakeLeave.TotalDayOffInYear',
                                                    userID = gblRecUser.userID
                                                ).maxDayOff_Year / 12) / 2
                                            )
                                        )
                                    ),
                                    "Date",
                                    DateAdd(
                                        dtp_rs_StartDay.SelectedDate,
                                        Value,
                                        TimeUnit.Days
                                    )
                                )
                            );
                            UpdateContext(
                                {
                                    locTotalDayLeave: If(
                                        Value(
                                            Right(
                                                RoundUp(
                                                    Sum(
                                                        colListDateRange,
                                                        Total
                                                    ),
                                                    1
                                                ),
                                                1
                                            )
                                        ) < 5,
                                        Round(
                                            Sum(
                                                colListDateRange,
                                                Total
                                            ),
                                            0
                                        ),
                                        Value(
                                            Right(
                                                RoundUp(
                                                    Sum(
                                                        colListDateRange,
                                                        Total
                                                    ),
                                                    1
                                                ),
                                                1
                                            )
                                        ) >= 5,
                                        RoundUp(
                                            Sum(
                                                colListDateRange,
                                                Total
                                            ),
                                            0
                                        )
                                    )
                                }
                            )*/
                        )
                    Text: ="Tạo"
                    ZIndex: =2

    ctn_rs_Header As groupContainer.horizontalAutoLayoutContainer:
        DropShadow: =DropShadow.None
        Height: =104
        LayoutMode: =LayoutMode.Auto
        Width: =1170
        X: =196
        ZIndex: =24

        ctn_rs_Tab As groupContainer.horizontalAutoLayoutContainer:
            AlignInContainer: =AlignInContainer.SetByContainer
            DropShadow: =DropShadow.None
            Height: =101
            LayoutAlignItems: =LayoutAlignItems.Center
            LayoutGap: =5
            LayoutMinHeight: =100
            LayoutMinWidth: =250
            LayoutMode: =LayoutMode.Auto
            PaddingLeft: =35
            Width: =1229
            X: =137
            ZIndex: =1

            btn_rs_Create As button:
                BorderStyle: =BorderStyle.None
                Color: =RGBA(94, 94, 94, 1)
                DisabledFill: =
                Fill: =RGBA(255, 255, 255, 1)
                Height: =28
                HoverFill: =ColorFade(RGBA(73, 113, 215, 1), -20%)
                OnSelect: =If(gblRecUser.roleID = 1,Navigate('Home User Screen'),Navigate('Home Manager Screen'))
                PressedFill: =RGBA(73, 113, 215, 1)
                RadiusBottomLeft: =5
                RadiusBottomRight: =5
                RadiusTopLeft: =5
                RadiusTopRight: =5
                Size: =13
                Text: ="Tổng quan"
                Width: =104
                X: =117
                Y: =36
                ZIndex: =1

            btn_rs_Overview As button:
                BorderStyle: =BorderStyle.None
                Fill: =RGBA(73, 113, 215, 1)
                Height: =28
                HoverFill: =ColorFade(Self.Fill, -20%)
                PressedColor: =Color.White
                PressedFill: =Self.Fill
                RadiusBottomLeft: =5
                RadiusBottomRight: =5
                RadiusTopLeft: =5
                RadiusTopRight: =5
                Size: =13
                Text: ="Tạo mới"
                Width: =104
                X: =191
                Y: =36
                ZIndex: =2

        ctn_rs_Info As groupContainer.horizontalAutoLayoutContainer:
            AlignInContainer: =AlignInContainer.SetByContainer
            DropShadow: =DropShadow.None
            Fill: =RGBA(220, 228, 252, 1)
            FillPortions: =0.3
            Height: =80
            LayoutMinHeight: =100
            LayoutMinWidth: =50
            LayoutMode: =LayoutMode.Auto
            PaddingLeft: =10
            PaddingRight: =10
            RadiusBottomLeft: =20
            RadiusBottomRight: =0
            RadiusTopLeft: =0
            RadiusTopRight: =20
            ZIndex: =2

            img_hs_Avatar_1 As image:
                AlignInContainer: =AlignInContainer.Center
                Height: =50
                Image: =User().Image
                LayoutMinHeight: =50
                RadiusBottomLeft: =img_hs_Avatar_1.Height
                RadiusBottomRight: =img_hs_Avatar_1.Height
                RadiusTopLeft: =img_hs_Avatar_1.Height
                RadiusTopRight: =img_hs_Avatar_1.Height
                Width: =50
                ZIndex: =1

            ctn_hs_Info2_1 As groupContainer.verticalAutoLayoutContainer:
                AlignInContainer: =AlignInContainer.SetByContainer
                DropShadow: =DropShadow.None
                LayoutDirection: =LayoutDirection.Vertical
                LayoutMinHeight: =0
                LayoutMinWidth: =0
                LayoutMode: =LayoutMode.Auto
                PaddingLeft: =5
                ZIndex: =2

                lbl_hs_Name_1 As label:
                    FontWeight: =FontWeight.Bold
                    PaddingTop: =20
                    Size: =12
                    Text: =User().FullName
                    Wrap: =false
                    ZIndex: =1

                lbl_hs_Mail_1 As label:
                    PaddingBottom: =20
                    Size: =12
                    Text: =User().Email
                    Wrap: =false
                    ZIndex: =2

    ctn_Navigate_3 As groupContainer.verticalAutoLayoutContainer:
        BorderStyle: =BorderStyle.None
        DropShadow: =DropShadow.None
        Fill: =RGBA(255, 255, 255, 1)
        Height: =768
        LayoutAlignItems: =LayoutAlignItems.Stretch
        LayoutDirection: =LayoutDirection.Vertical
        LayoutMode: =LayoutMode.Auto
        PaddingBottom: =70
        RadiusBottomLeft: =20
        RadiusBottomRight: =0
        RadiusTopLeft: =20
        RadiusTopRight: =0
        Width: =196
        ZIndex: =25

        ctn_HeaderMenu_4 As groupContainer.horizontalAutoLayoutContainer:
            AlignInContainer: =AlignInContainer.SetByContainer
            DropShadow: =DropShadow.None
            FillPortions: =0
            Height: =100
            LayoutAlignItems: =LayoutAlignItems.Center
            LayoutMinHeight: =100
            LayoutMinWidth: =1
            LayoutMode: =LayoutMode.Auto
            PaddingLeft: =20
            PaddingRight: =20
            ZIndex: =1

            img_Logo_3 As image:
                Height: =110
                Image: =Name
                Width: =50
                X: =11
                Y: =13
                ZIndex: =1

            lbl_HeaderTitleMenu_4 As label:
                Color: =RGBA(73, 113, 215, 1)
                FontWeight: =FontWeight.Bold
                Size: =15
                Text: ="Nghỉ phép"
                Width: =145
                ZIndex: =2

        ctn_NavigationMenu_3 As groupContainer.verticalAutoLayoutContainer:
            AlignInContainer: =AlignInContainer.SetByContainer
            DropShadow: =DropShadow.None
            Fill: =RGBA(255, 255, 255, 1)
            LayoutDirection: =LayoutDirection.Vertical
            LayoutMinHeight: =100
            LayoutMinWidth: =0
            LayoutMode: =LayoutMode.Auto
            RadiusBottomLeft: =0
            RadiusBottomRight: =0
            RadiusTopLeft: =0
            RadiusTopRight: =0
            ZIndex: =3

            gal_NavigationMenu_3 As gallery.galleryVertical:
                Fill: =RGBA(255, 255, 255, 1)
                Height: =652
                Items: |-
                    =If(gblRecUser.roleID = 1,Table({ID:1,Image:Home,Title:"Trang chủ",Navigate:'Home User Screen'},{ID:2,Image:Analytics,Title:"Báo cáo",Navigate:'Statistical User Screen'}),Or(gblRecUser.roleID = 2,gblRecUser.roleID = 3,gblRecUser.roleID = 4),Table({ID:1,Image:Home,Title:"Trang chủ",Navigate:'Home Manager Screen'},{ID:2,Image:'Admin Settings Male',Title:"Phê duyệt",Navigate:'Approve Screen'},{ID:3,Image:Analytics,Title:"Báo cáo",Navigate:'Statistical Manager Screen'}),gblRecUser.roleID = 5 Or gblRecUser.roleID = 7,Table({ID:1,Image:Home,Title:"Trang chủ",Navigate:'Home Manager Screen'},{ID:2,Image:'Data Recovery',Title:"Thiết lập",Navigate:'Leave Day Screen'},{ID:3,Image:Analytics,Title:"Báo cáo",Navigate:'Statistical Manager Screen'}),gblRecUser.roleID = 6,Table({ID:1,Image:'Data Recovery',Title:"Thiết lập",Navigate:'User Screen'}))
                Layout: =Layout.Vertical
                LayoutMinHeight: =287
                LayoutMinWidth: =0
                LoadingSpinner: =LoadingSpinner.Data
                OnSelect: =Navigate(ThisItem.Navigate)
                ShowScrollbar: =false
                TemplateSize: =50
                Width: =155
                X: =251
                Y: =115
                ZIndex: =1

                img_MenuImage_3 As image:
                    Height: =30
                    Image: =ThisItem.Image
                    OnSelect: =Select(Parent)
                    Width: =40
                    X: =15
                    Y: =10
                    ZIndex: =1

                lbl_MenuTitle_3 As label:
                    Color: =RGBA(149, 149, 149, 1)
                    FontWeight: =FontWeight.Semibold
                    Height: =29
                    OnSelect: =Select(Parent)
                    Text: =ThisItem.Title
                    Width: =117
                    X: =60
                    Y: =10
                    ZIndex: =2

                btn_Select_4 As button:
                    BorderThickness: =0
                    Fill: =If(ThisItem.ID = gblMenuFunctionSelected,RGBA(149, 149, 149,0.2),RGBA(0, 0, 0, 0))
                    Height: =50
                    HoverFill: =ColorFade(RGBA(149, 149, 149,0.4), -20%)
                    OnSelect: |-
                        =Select(Parent);
                        Set(gblMenuFunctionSelected,ThisItem.ID)
                    PressedFill: =RGBA(149, 149, 149,0.5)
                    RadiusBottomLeft: =0
                    RadiusBottomRight: =0
                    RadiusTopLeft: =0
                    RadiusTopRight: =0
                    Text: =""
                    Width: =195
                    X: =-5
                    ZIndex: =3

        btn_Exit_3 As button:
            AlignInContainer: =AlignInContainer.Center
            BorderColor: =RGBA(73, 113, 215, 1)
            Color: =RGBA(116, 116, 116, 1)
            Fill: =RGBA(255, 255, 255, 1)
            HoverFill: =ColorFade(RGBA(73, 113, 215, 1), -20%)
            OnSelect: =Exit()
            PressedColor: =Color.White
            PressedFill: =RGBA(73, 113, 215, 1)
            Text: ="Thoát"
            X: =18
            Y: =682
            ZIndex: =4

    ctn_rs_Review As groupContainer.manualLayoutContainer:
        Fill: =RGBA(0, 0, 0, 0.5)
        Height: =768
        RadiusBottomLeft: =20
        RadiusBottomRight: =20
        RadiusTopLeft: =20
        RadiusTopRight: =20
        Visible: =locSubmit
        Width: =1366
        ZIndex: =26

        btn_ds_BackGround_7 As button:
            BorderStyle: =BorderStyle.None
            DisabledFill: =RGBA(255, 255, 255, 1)
            DisplayMode: =DisplayMode.Disabled
            Height: =190
            RadiusBottomLeft: =5
            RadiusBottomRight: =5
            RadiusTopLeft: =5
            RadiusTopRight: =5
            Text: =""
            Width: =608
            X: =375
            Y: =297
            ZIndex: =1

        lbl_ds_Title_12 As label:
            FontWeight: =FontWeight.Bold
            Text: ="Xác nhận"
            X: =387
            Y: =302
            ZIndex: =2

        shp_ds_Deco_15 As rectangle:
            Fill: =RGBA(202, 202, 202, 1)
            Height: =1
            Width: =608
            X: =375
            Y: =347
            ZIndex: =3

        ico_ds_Cancel_7 As icon.Cancel:
            Color: =RGBA(149, 149, 149, 1)
            Height: =29
            Icon: =Icon.Cancel
            OnSelect: |-
                =UpdateContext({locSubmit:false})
            Width: =25
            X: =942
            Y: =304
            ZIndex: =4

        lbl_ds_DepartmentName_6 As label:
            FontWeight: =FontWeight.Semibold
            Text: ="Bạn chắc chắn muốn gửi yêu cầu ?"
            Width: =596
            X: =387
            Y: =369
            ZIndex: =5

        shp_ds_Deco_5 As rectangle:
            Fill: =RGBA(202, 202, 202, 1)
            Height: =1
            Width: =608
            X: =375
            Y: =432
            ZIndex: =6

        btn_ds_Submit_9 As button:
            BorderThickness: =1
            Fill: =RGBA(0, 89, 204, 1)
            Height: =36
            HoverFill: =ColorFade(Self.Fill, -20%)
            OnSelect: |-
                =//Tạo yêu cầu
                Set(
                    gblRequest,
                    Patch(
                        'ASTakeLeave.LeaveRequest',
                        Defaults('ASTakeLeave.LeaveRequest'),
                        {
                            departmentID: gblRecUser.departmentID,
                            divisionID: gblRecUser.divisionID,
                            userID: gblRecUser.userID,
                            totalDayOff: Sum(
                                colTotalListDateRange,
                                Total
                            ),
                            totalDayUnpaid: If(
                                LookUp(
                                    'ASTakeLeave.TotalDayOffInYear',
                                    userID = gblRecUser.userID
                                ).totalDayOff_Year + Sum(
                                    colTotalListDateRange,
                                    Total
                                ) > LookUp(
                                    'ASTakeLeave.TotalDayOffInYear',
                                    userID = gblRecUser.userID
                                ).maxDayOff_Year,
                                (LookUp(
                                    'ASTakeLeave.TotalDayOffInYear',
                                    userID = gblRecUser.userID
                                ).totalDayOff_Year + Sum(
                                    colTotalListDateRange,
                                    Total
                                )) - LookUp(
                                    'ASTakeLeave.TotalDayOffInYear',
                                    userID = gblRecUser.userID
                                ).maxDayOff_Year,
                                0
                            ),
                            startDate: dtp_rs_StartDay.SelectedDate,
                            endDate: dtp_rs_FinishDay.SelectedDate,
                            startDateValue: Value(Day(dtp_rs_StartDay.SelectedDate) & Month(dtp_rs_StartDay.SelectedDate) & Year(dtp_rs_StartDay.SelectedDate)),
                            endDateValue: Value(Day(dtp_rs_FinishDay.SelectedDate) & Month(dtp_rs_FinishDay.SelectedDate) & Year(dtp_rs_FinishDay.SelectedDate)),
                            startDateType: LookUp(
                                colDateRange,
                                ID = 1
                            ).Status,
                            endDateType: LookUp(
                                colDateRange,
                                ID = 2
                            ).Status,
                            reason: drp_rs_Reason.Selected.description,
                            reasonDetail: txt_rs_Detail.Text,
                            handOverUserID: LookUp(
                                gblColAllUser,
                                OData__x0033_65AccountInfo.Email = drp_rs_HandOver.Selected.Email
                            ).userID,
                            handOverContent: txt_rs_HandOverContent.Text,
                            currentApproveLevel: If(
                                gblRecUser.roleID = 1 And Sum(
                                    colTotalListDateRange,
                                    Total
                                ) <= 12,
                                1,
                                gblRecUser.roleID = 1 And Sum(
                                    colTotalListDateRange,
                                    Total
                                ) > 12,
                                2,
                                gblRecUser.roleID = 2,
                                2,
                                gblRecUser.roleID = 3,
                                3,
                                gblRecUser.roleID = 4,
                                4,
                                gblRecUser.roleID = 5 And Sum(
                                    colTotalListDateRange,
                                    Total
                                ) <= 12,
                                1,
                                gblRecUser.roleID = 5 And Sum(
                                    colTotalListDateRange,
                                    Total
                                ) > 12,
                                2,
                                gblRecUser.roleID = 7,
                                2
                            ),
                            maxApproveLevel: If(
                                //Role quản lý
                                gblRecUser.roleID = 2 And Sum(
                                    colTotalListDateRange,
                                    Total
                                ) <= 12,
                                2,
                                gblRecUser.roleID = 2 And Sum(
                                    colTotalListDateRange,
                                    Total
                                ) >= 12,
                                3,
                                //Role nhân viên
                                gblRecUser.roleID = 1 And Sum(
                                    colTotalListDateRange,
                                    Total
                                ) <= 12,
                                2,
                                gblRecUser.roleID = 1 And Sum(
                                    colTotalListDateRange,
                                    Total
                                ) > 12,
                                3,
                                //Role HR/C&B
                                gblRecUser.roleID = 5 And Sum(
                                    colTotalListDateRange,
                                    Total
                                ) <= 12,
                                2,
                                gblRecUser.roleID = 5 And Sum(
                                    colTotalListDateRange,
                                    Total
                                ) > 12,
                                3,
                                //Role giám đốc khối
                                gblRecUser.roleID = 3 And Sum(
                                    colTotalListDateRange,
                                    Total
                                ) <= 12,
                                1,
                                gblRecUser.roleID = 3 And Sum(
                                    colTotalListDateRange,
                                    Total
                                ) > 12,
                                2,
                                //Role giám đốc điều hành
                                gblRecUser.roleID = 4,
                                1,
                                //Role trưởng HR
                                gblRecUser.roleID = 7 And Sum(
                                    colTotalListDateRange,
                                    Total
                                ) <= 12,
                                2,
                                gblRecUser.roleID = 7 And Sum(
                                    colTotalListDateRange,
                                    Total
                                ) > 12,
                                3
                            ),
                            status: If(gblRecUser.roleID = 4,2,gblRecUser.roleID = 3 And Sum(
                                    colTotalListDateRange,
                                    Total
                                ) <= 12,2,1),
                            createDayValue: Value(Day(Today()) & Month(Today()) & Year(Today()))
                        },
                        Form2.Updates
                    )
                );
                //Nếu người tạo là quản lý, giám đốc hoặc giám đốc điều hành thì yêu cầu tự động phê duyệt tại bước này (ghi nhận lịch sử)
                If(
                    gblRecUser.roleID = 2,
                    Patch(
                        'ASTakeLeave.HistoryApprove',
                        Defaults('ASTakeLeave.HistoryApprove'),
                        {
                            requestID: gblRequest.ID,
                            userID: gblRecUser.userID,
                            status: 2,
                            step:1
                        }
                    ),
                    gblRecUser.roleID = 3,
                    Patch(
                        'ASTakeLeave.HistoryApprove',
                        Defaults('ASTakeLeave.HistoryApprove'),
                        {
                            requestID: gblRequest.ID,
                            userID: gblRecUser.userID,
                            status: 2,
                            step:1
                        }
                    ),
                    gblRecUser.roleID = 4,
                    Patch(
                        'ASTakeLeave.HistoryApprove',
                        Defaults('ASTakeLeave.HistoryApprove'),
                        {
                            requestID: gblRequest.ID,
                            userID: gblRecUser.userID,
                            status: 2,
                            step:1
                        }
                    )
                );
                //Ghi nhận tháng nghỉ
                ForAll(
                    Filter(colRecordTotalDayLeaveByMonthCalculated,TotalLeaveDay > 0 Or Value(TotalLeaveUnpaid) > 0) As Temp,
                    Patch(
                        'ASTakeLeave.RequestCalculatedDays',
                        Defaults('ASTakeLeave.RequestCalculatedDays'),
                        {
                            year: Year(Today()),
                            requestID: gblRequest.ID,
                            month:Temp.Month,
                            totalDayOffWithPaid:Temp.TotalLeaveDay,
                            totalDayOffUnpaid:Value(Temp.TotalLeaveUnpaid)
                        }
                    )
                );
                /*'ASTakeLeave.SendMail'.Run(drp_rs_HandOver.Selected.Email,gblRecUser.fullName & " đã tạo yêu cầu nghỉ phép và bàn giao công việc","Thời gian tạo yêu cầu " & Now() & "<br>" & "Ngày nghỉ từ " & dtp_rs_StartDay.SelectedDate & " đến " & dtp_rs_FinishDay.SelectedDate & "<br>" & "Nội dung bàn giao công việc: " & txt_rs_HandOverContent.Text);*/
                Notify(
                    "Gửi thành công",
                    NotificationType.Success,
                    1500
                );
                Reset(drp_rs_Reason);
                Reset(txt_rs_Detail);
                Reset(dtp_rs_StartDay);
                Reset(dtp_rs_FinishDay);
                Reset(drp_rs_HandOver);
                Reset(txt_rs_HandOverContent);
                ResetForm(Form2);
                UpdateContext({locSubmit: false})
            PressedColor: =RGBA(255,255,255,1)
            PressedFill: =Self.Fill
            RadiusBottomLeft: =5
            RadiusBottomRight: =5
            RadiusTopLeft: =5
            RadiusTopRight: =5
            Text: ="Gửi"
            Width: =87
            X: =879
            Y: =443
            ZIndex: =7

        btn_ds_Cancel_7 As button:
            BorderThickness: =1
            Color: =RGBA(0, 0, 0, 1)
            Fill: =RGBA(255, 255, 255, 1)
            Height: =36
            HoverFill: =ColorFade(Self.Fill, -20%)
            OnSelect: |-
                =UpdateContext({locSubmit:false})
            PressedColor: =RGBA(0,0,0,1)
            PressedFill: =Self.Fill
            RadiusBottomLeft: =5
            RadiusBottomRight: =5
            RadiusTopLeft: =5
            RadiusTopRight: =5
            Text: ="Hủy"
            Width: =87
            X: =782
            Y: =443
            ZIndex: =8

