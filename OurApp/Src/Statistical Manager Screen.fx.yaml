"'Statistical Manager Screen' As screen":
    Fill: =RGBA(80,80,80,1)
    OnVisible: |+
        =//Lấy ngày phép trong tất cả các năm theo phân quyền
        If(
            IsEmpty(locColReportManagerTotalDayOffInYear),  //Chỉ lấy lần đầu
            If(
                gblRecUser.roleID = 2,  //Nếu là Manager -----------------------
                ForAll(
                    gblColUserBelong As temp,   //collection đã có từ onstart
                    Concurrent(
                        Collect(                
                            locColReportManagerTotalDayOffInYear,   //Lấy các thông tin nghỉ phép trong tất cả năm                       
                            AddColumns(
                                Filter('ASTakeLeave.TotalDayOffInYear', userID = temp.userID, active = 1),
                                "departmentID",
                                LookUp(gblColAllUser, userID = temp.userID && active = 1 ).departmentID,
                                "divisionID",
                                LookUp(gblColAllUser, userID = temp.userID && active = 1).divisionID
                            )
                        ),
                        Collect(
                            locColReportManagerTotalDayOffInMonth,  //Lấy các thông tin nghỉ phép trong tất cả tháng
                            AddColumns(
                                Filter('ASTakeLeave.TotalDayOffInMonth', userID = temp.userID),
                                "departmentID",
                                LookUp(gblColAllUser, userID = temp.userID && active = 1).departmentID,
                                "divisionID",
                                LookUp(gblColAllUser, userID = temp.userID && active = 1).divisionID
                            )
                        )
                    );
                );
                Collect(    //Tạo collection chứa các year dữ liệu
                    locColReportYear,
                    Sort(Distinct(locColReportManagerTotalDayOffInYear, year), Value, SortOrder.Ascending)
                ),
                
                If(
                    gblRecUser.roleID = 3,  //Nếu là giám đốc khối ----------------------------------
                    ForAll(
                        Filter(gblColAllUser, divisionID = gblRecUser.divisionID, active = 1) As temp,
                        Concurrent(
                            Collect(
                                locColReportManagerTotalDayOffInYear,
                                Filter('ASTakeLeave.TotalDayOffInYear', userID = temp.userID, active = 1),
                                {
                                    departmentID: temp.departmentID,
                                    divisionID: temp.divisionID
                                }
                            ),
                            Collect(
                                locColReportManagerTotalDayOffInMonth,
                                Filter('ASTakeLeave.TotalDayOffInMonth', userID = temp.userID, year = Year(Today())),
                                {
                                    departmentID: temp.departmentID,
                                    divisionID: temp.divisionID
                                }
                            )
                        )
                    );
                    Collect(    //Tạo collection chứa các year dữ liệu
                        locColReportYear,
                        Sort(Distinct(locColReportManagerTotalDayOffInYear, year), Value, SortOrder.Ascending)
                    ),
        
                    If(
                        gblRecUser.roleID = 4 || gblRecUser.roleID = 5 || gblRecUser.roleID = 7,    //Nếu là giám đốc, HR, trưởng HR ------------------
                        Concurrent(
                            Collect(
                                locColReportManagerTotalDayOffInYear,
                                Filter('ASTakeLeave.TotalDayOffInYear', active = 1)
                            ),
                            Collect(    
                                locColReportManagerTotalDayOffInMonthTemp1,  //lấy 6 tháng đầu
                                AddColumns(
                                    Filter('ASTakeLeave.TotalDayOffInMonth', year = Year(Today()), month <= 6) As temp,
                                    "departmentID",
                                    LookUp(gblColAllUser, userID = temp.userID && active = 1).departmentID,
                                    "divisionID",
                                    LookUp(gblColAllUser, userID = temp.userID && active = 1).divisionID
                                )
                            ),
                            Collect(    
                                locColReportManagerTotalDayOffInMonthTemp2,  //lấy 6 tháng sau
                                AddColumns(
                                    Filter('ASTakeLeave.TotalDayOffInMonth', year = Year(Today()), month >= 7) As temp,
                                    "departmentID",
                                    LookUp(gblColAllUser, userID = temp.userID && active = 1).departmentID,
                                    "divisionID",
                                    LookUp(gblColAllUser, userID = temp.userID && active = 1).divisionID
                                )
                            ),
                            Collect(    //Tạo collection chứa các year dữ liệu
                                locColReportYear,
                                {
                                    Value: Year(Today())
                                }
                            )
                        );
                        //Gộp 2 collection temp
                        Collect(
                            locColReportManagerTotalDayOffInMonth,
                            locColReportManagerTotalDayOffInMonthTemp1,
                            locColReportManagerTotalDayOffInMonthTemp2
                        )  
                    )
                ) 
            );
        
            //Tạo collection dùng cho bộ lọc
            Collect(
                locColReportManagerFilterAdvance,
                Table(
                    {
                        ID: 0,
                        title: "Theo năm",
                        status: true
                    },
                    {
                        ID: 1,
                        title: "Tất cả nhân viên",
                        status: true
                    },
                    {
                        ID: 2,
                        title: "Theo Phòng",
                        status: true
                    },
                    {
                        ID: 3,
                        title: "Theo nhân viên",
                        status: true
                    }
                )
            );
        
            //Tạo collection cho radio button
            Collect(
                locColReportExportRadio,
                Table(
                    {
                        ID: 1,
                        text: "Theo biểu đồ hiện tại"
                    },
                    {
                        ID: 2,
                        text: $"Tất cả trong năm hiện tại ({Year(Today())})"
                    }
                )
            )
        );
        
        //Tắt các filter khi vào
        UpdateIf(locColReportManagerFilterAdvance, ID > 0, {status: false});
        
        //Cho chạy button chứa code tạo report
        Select(btn_sms_CalculateFilter);
        

    btn_hs_BackGroundScreen_2 As button:
        BorderStyle: =BorderStyle.None
        DisabledFill: =RGBA(241, 244, 250, 1)
        DisplayMode: =DisplayMode.Disabled
        Height: =768
        RadiusBottomLeft: =20
        RadiusBottomRight: =20
        RadiusTopLeft: =20
        RadiusTopRight: =20
        Text: =""
        Width: =1366
        ZIndex: =1

    ctn_hs_Navigate_2 As groupContainer.verticalAutoLayoutContainer:
        BorderStyle: =BorderStyle.None
        DropShadow: =DropShadow.None
        Fill: =RGBA(255, 255, 255, 1)
        Height: =768
        LayoutAlignItems: =LayoutAlignItems.Stretch
        LayoutDirection: =LayoutDirection.Vertical
        LayoutMode: =LayoutMode.Auto
        PaddingBottom: =70
        RadiusBottomLeft: =20
        RadiusBottomRight: =0
        RadiusTopLeft: =20
        RadiusTopRight: =0
        Width: =196
        ZIndex: =18

        ctn_HeaderMenu_3 As groupContainer.horizontalAutoLayoutContainer:
            AlignInContainer: =AlignInContainer.SetByContainer
            DropShadow: =DropShadow.None
            FillPortions: =0
            Height: =100
            LayoutAlignItems: =LayoutAlignItems.Center
            LayoutMinHeight: =100
            LayoutMinWidth: =1
            LayoutMode: =LayoutMode.Auto
            PaddingLeft: =20
            PaddingRight: =20
            ZIndex: =1

            img_hs_Logo_3 As image:
                Height: =110
                Image: =Name
                Width: =50
                X: =11
                Y: =13
                ZIndex: =1

            Label1_3 As label:
                Color: =RGBA(73, 113, 215, 1)
                FontWeight: =FontWeight.Bold
                Size: =15
                Text: ="Nghỉ phép"
                Width: =145
                ZIndex: =2

        ctn_NavigationMenu_10 As groupContainer.verticalAutoLayoutContainer:
            AlignInContainer: =AlignInContainer.SetByContainer
            DropShadow: =DropShadow.None
            Fill: =RGBA(255, 255, 255, 1)
            LayoutAlignItems: =LayoutAlignItems.Stretch
            LayoutDirection: =LayoutDirection.Vertical
            LayoutMinHeight: =100
            LayoutMinWidth: =0
            LayoutMode: =LayoutMode.Auto
            PaddingBottom: =2
            RadiusBottomLeft: =0
            RadiusBottomRight: =0
            RadiusTopLeft: =0
            RadiusTopRight: =0
            ZIndex: =3

            gal_NavigationMenu_10 As gallery.galleryVertical:
                AlignInContainer: =AlignInContainer.SetByContainer
                Fill: =RGBA(255, 255, 255, 1)
                Height: =652
                Items: |-
                    =If(gblRecUser.roleID = 1,Table({ID:1,Image:Home,Title:"Trang chủ",Navigate:'Home User Screen'},{ID:2,Image:Analytics,Title:"Báo cáo",Navigate:'Statistical User Screen'}),Or(gblRecUser.roleID = 2,gblRecUser.roleID = 3,gblRecUser.roleID = 4),Table({ID:1,Image:Home,Title:"Trang chủ",Navigate:'Home Manager Screen'},{ID:2,Image:'Admin Settings Male',Title:"Phê duyệt",Navigate:'Approve Screen'},{ID:3,Image:Analytics,Title:"Báo cáo",Navigate:'Statistical Manager Screen'}),gblRecUser.roleID = 5 Or gblRecUser.roleID = 7,Table({ID:1,Image:Home,Title:"Trang chủ",Navigate:'Home Manager Screen'},{ID:2,Image:'Data Recovery',Title:"Thiết lập",Navigate:'Leave Day Screen'},{ID:3,Image:Analytics,Title:"Báo cáo",Navigate:'Statistical Manager Screen'}),gblRecUser.roleID = 6,Table({ID:1,Image:'Data Recovery',Title:"Thiết lập",Navigate:'User Screen'}))
                Layout: =Layout.Vertical
                LayoutMinHeight: =287
                LayoutMinWidth: =0
                LoadingSpinner: =LoadingSpinner.Data
                OnSelect: =Navigate(ThisItem.Navigate)
                ShowScrollbar: =false
                TemplateSize: =50
                Width: =155
                X: =251
                Y: =115
                ZIndex: =1

                img_MenuImage_10 As image:
                    Height: =30
                    Image: =ThisItem.Image
                    OnSelect: =Select(Parent)
                    Width: =40
                    X: =15
                    Y: =10
                    ZIndex: =1

                lbl_MenuTitle_10 As label:
                    Color: =RGBA(149, 149, 149, 1)
                    FontWeight: =FontWeight.Semibold
                    Height: =29
                    OnSelect: =Select(Parent)
                    Text: =ThisItem.Title
                    Width: =117
                    X: =60
                    Y: =10
                    ZIndex: =2

                btn_Select_3 As button:
                    BorderThickness: =0
                    Fill: =If(ThisItem.ID = gblMenuFunctionSelected,RGBA(149, 149, 149,0.2),RGBA(0, 0, 0, 0))
                    Height: =50
                    HoverFill: =ColorFade(RGBA(149, 149, 149,0.4), -20%)
                    OnSelect: |-
                        =Select(Parent);
                        Set(gblMenuFunctionSelected,ThisItem.ID)
                    PressedFill: =RGBA(149, 149, 149,0.5)
                    RadiusBottomLeft: =0
                    RadiusBottomRight: =0
                    RadiusTopLeft: =0
                    RadiusTopRight: =0
                    Text: =""
                    Width: =195
                    X: =-5
                    ZIndex: =3

            btn_Exit_11 As button:
                AlignInContainer: =AlignInContainer.Center
                BorderColor: =RGBA(73, 113, 215, 1)
                Color: =RGBA(116, 116, 116, 1)
                Fill: =RGBA(255, 255, 255, 1)
                HoverFill: =ColorFade(RGBA(73, 113, 215, 1), -20%)
                OnSelect: =Exit()
                PressedColor: =Color.White
                PressedFill: =RGBA(73, 113, 215, 1)
                Text: ="Thoát"
                X: =18
                Y: =682
                ZIndex: =2

    ctn_hs_Title_2 As groupContainer.verticalAutoLayoutContainer:
        DropShadow: =DropShadow.None
        Height: =41
        LayoutMode: =LayoutMode.Auto
        PaddingLeft: =30
        PaddingRight: =36
        Width: =1170
        X: =196
        Y: =104
        ZIndex: =20

        lbl_hs_Title_2 As label:
            Color: =RGBA(43, 54, 74, 1)
            FillPortions: =1
            FontWeight: =FontWeight.Bold
            Height: =41
            Size: =18
            Text: ="Báo cáo"
            Width: =281
            X: =191
            Y: =101
            ZIndex: =1

        Button3 As button:
            BorderThickness: =1
            Fill: =RGBA(73, 113, 215, 1)
            HoverFill: =ColorFade(RGBA(73, 113, 215, 1), -20%)
            OnSelect: |-
                =UpdateContext({locExport:true})
            PressedColor: =Color.White
            PressedFill: =Self.Fill
            RadiusBottomLeft: =5
            RadiusBottomRight: =5
            RadiusTopLeft: =5
            RadiusTopRight: =5
            Text: ="Xuất file"
            ZIndex: =2

    ctn_hs_MainContent_2 As groupContainer.horizontalAutoLayoutContainer:
        DropShadow: =DropShadow.None
        Height: =623
        LayoutGap: =10
        LayoutMode: =LayoutMode.Auto
        PaddingBottom: =10
        PaddingLeft: =35
        PaddingRight: =35
        PaddingTop: =10
        Width: =1170
        X: =196
        Y: =145
        ZIndex: =23

        ctn_hs_List_2 As groupContainer.verticalAutoLayoutContainer:
            DropShadow: =DropShadow.None
            Fill: =RGBA(255, 255, 255, 1)
            LayoutAlignItems: =LayoutAlignItems.Stretch
            LayoutDirection: =LayoutDirection.Vertical
            LayoutMinHeight: =0
            LayoutMinWidth: =0
            LayoutMode: =LayoutMode.Auto
            PaddingLeft: =5
            PaddingRight: =5
            ZIndex: =1

            Container6_2 As groupContainer.horizontalAutoLayoutContainer:
                DropShadow: =DropShadow.None
                FillPortions: =0
                Height: =60
                LayoutMinHeight: =50
                LayoutMinWidth: =250
                LayoutMode: =LayoutMode.Auto
                ZIndex: =1

                Button1_2 As button:
                    Align: =Align.Left
                    AlignInContainer: =AlignInContainer.Stretch
                    BorderStyle: =BorderStyle.None
                    Color: =RGBA(124, 124, 124, 1)
                    DisabledColor: =RGBA(124, 124, 124, 1)
                    DisabledFill: =RGBA(255, 255, 255, 1)
                    DisplayMode: =DisplayMode.Disabled
                    FillPortions: =1
                    LayoutMinHeight: =50
                    PaddingLeft: =10
                    PaddingRight: =10
                    RadiusBottomLeft: =0
                    RadiusBottomRight: =0
                    Text: ="Biểu đồ thống kê theo tháng"
                    ZIndex: =1

            Rectangle2 As rectangle:
                Fill: =RGBA(73, 113, 215, 1)
                Height: =2
                LayoutMinHeight: =2
                ZIndex: =2

            CompositeColumnChart1 As group:
                Height: =5
                LayoutMinHeight: =5
                LayoutMinWidth: =5
                Width: =5
                X: =40
                Y: =40
                ZIndex: =2

                ColumnChart1 As barChart:
                    GridStyle: =GridStyle.All
                    Height: =500
                    ItemColorSet: =[RGBA(49, 130, 93, 1),Color.Red, RGBA(94,193,108,1), RGBA(246,199,144,1), RGBA(247,199,114,1), RGBA(247,180,91,1), RGBA(246,143,100,1), RGBA(212,96,104,1), RGBA(148, 110, 176, 1), RGBA(118, 154, 204, 1), RGBA(96, 197, 234, 1)]
                    Items: =locColManagerReportStat
                    X: =40
                    XLabelAngle: =40
                    Y: =70
                    ZIndex: =4

                Legend1 As legend:
                    FillPortions: =1
                    Height: =80
                    ItemColorSet: =ColumnChart1.ItemColorSet
                    Items: =["Tổng đã nghỉ", "Tổng không lương"]
                    Width: =320
                    X: =80
                    Y: =480
                    ZIndex: =5

        ctn_hs_Statistical_2 As groupContainer.verticalAutoLayoutContainer:
            DropShadow: =DropShadow.None
            Fill: =RGBA(255, 255, 255, 1)
            FillPortions: =0.3
            LayoutAlignItems: =LayoutAlignItems.Stretch
            LayoutDirection: =LayoutDirection.Vertical
            LayoutGap: =5
            LayoutMinHeight: =100
            LayoutMinWidth: =0
            LayoutMode: =LayoutMode.Auto
            PaddingBottom: =5
            PaddingLeft: =5
            PaddingRight: =5
            PaddingTop: =5
            RadiusBottomLeft: =10
            RadiusBottomRight: =10
            RadiusTopLeft: =10
            RadiusTopRight: =10
            ZIndex: =2

            lbl_hs_Statistical_4 As label:
                Color: =RGBA(124, 124, 124, 1)
                FontWeight: =FontWeight.Semibold
                Height: =50
                PaddingLeft: =10
                Size: =15
                Text: ="Bộ lọc nâng cao"
                ZIndex: =1

            Rectangle2_1 As rectangle:
                Fill: =RGBA(73, 113, 215, 1)
                Height: =2
                LayoutMinHeight: =2
                ZIndex: =2

            Gallery4 As gallery.variableTemplateHeightGallery:
                DelayItemLoading: =true
                Items: =locColReportManagerFilterAdvance
                Layout: =Layout.Vertical
                LayoutMinHeight: =287
                LayoutMinWidth: =0
                LoadingSpinner: =LoadingSpinner.Data
                ShowScrollbar: =false
                TemplateSize: =210
                ZIndex: =3

                Label2 As label:
                    FontWeight: =FontWeight.Semibold
                    OnSelect: =Select(Parent)
                    Text: =ThisItem.title
                    Visible: |-
                        =If(
                            ThisItem.ID = 2 && gblRecUser.roleID <= 2, 
                            false, 
                            true
                        ) 
                    Y: =8
                    ZIndex: =1

                Toggle2 As toggleSwitch:
                    BorderStyle: =BorderStyle.None
                    Default: =ThisItem.status
                    OnCheck: |-
                        =//Patch(colFilterAdvance,LookUp(colFilterAdvance,ID = ThisItem.ID),{Status:true});
                    OnSelect: |+
                        =Patch(                                  //update status của filter
                            locColReportManagerFilterAdvance,
                            ThisItem,
                            {status: !ThisItem.status}
                        );
                        
                        If(                                     //nếu filter từ tắt -> bật, tắt các filter còn lại
                            ThisItem.status = false,
                            UpdateIf(
                                locColReportManagerFilterAdvance, 
                                ID <> ThisItem.ID && ID > 0,
                                {status: false}
                            );
                        );
                        
                        //Chạy lại code tính report
                        Select(btn_sms_CalculateFilter);
                        
                        
                            
                        
                    OnUncheck: |-
                        =//Patch(colFilterAdvance,LookUp(colFilterAdvance,ID = ThisItem.ID),{Status:false})
                    ShowLabel: =false
                    Visible: |-
                        =If(
                            ThisItem.ID = 0 || (ThisItem.ID = 2 && gblRecUser.roleID <= 2), 
                            false, 
                            true
                        ) 
                    Width: =59
                    X: =171
                    Y: =14
                    ZIndex: =2

                Container5 As groupContainer.verticalAutoLayoutContainer:
                    DropShadow: =DropShadow.Semibold
                    Height: =160
                    LayoutDirection: =LayoutDirection.Vertical
                    LayoutMode: =LayoutMode.Auto
                    Visible: =If(ThisItem.ID = 3 And ThisItem.status = true,true)
                    Width: =232
                    Y: =48
                    ZIndex: =3

                    Label5 As label:
                        AlignInContainer: =AlignInContainer.Stretch
                        Text: ="Nhân viên"
                        ZIndex: =1

                    Dropdown3 As dropdown:
                        AlignInContainer: =AlignInContainer.Center
                        BorderColor: =RGBA(73, 113, 215, 1)
                        BorderThickness: =1
                        ChevronBackground: =RGBA(73, 113, 215, 1)
                        Height: =35
                        Items: =[1, 2]
                        LayoutMinWidth: =0
                        Visible: =false
                        Width: =200
                        ZIndex: =2

                    cbb_sms_User As combobox:
                        AlignInContainer: =AlignInContainer.Center
                        DisplayFields: =["DisplayName","Email","Picture"]
                        Height: =35
                        InputTextPlaceholder: ="Chọn nhân sự"
                        Items: |-
                            =Switch(
                                gblRecUser.roleID,
                            
                                2,
                                Filter(gblColAllUser365, Email exactin gblColUserBelong.email),
                            
                                3,
                                Filter(gblColAllUser365, Email exactin Filter(gblColAllUser, divisionID = gblRecUser.divisionID).email),
                                
                                gblColAllUser365
                            )
                        OnChange: =Select(btn_sms_CalculateFilter);
                        PaddingBottom: =0
                        PaddingRight: =0
                        PaddingTop: =0
                        SearchFields: =["DisplayName"]
                        SearchItems: |-
                            =Search(Switch(
                                gblRecUser.roleID,
                            
                                2,
                                Filter(gblColAllUser365, Email exactin gblColUserBelong.email),
                            
                                3,
                                Filter(gblColAllUser365, Email exactin Filter(gblColAllUser, divisionID = gblRecUser.divisionID).email),
                                
                                gblColAllUser365
                            ),cbb_sms_User.SearchText,"DisplayName")
                        SelectMultiple: =false
                        Size: =10
                        Template: =ListItemTemplate.Double
                        Width: =200
                        ZIndex: =3

                    Label5_1 As label:
                        AlignInContainer: =AlignInContainer.Stretch
                        Text: ="Tháng"
                        ZIndex: =4

                    Dropdown3_1 As dropdown:
                        AlignInContainer: =AlignInContainer.Center
                        BorderColor: =RGBA(73, 113, 215, 1)
                        BorderThickness: =1
                        ChevronBackground: =RGBA(73, 113, 215, 1)
                        Default: =1
                        Height: =35
                        Items: =Sequence(12,1)
                        LayoutMinWidth: =0
                        OnChange: =Select(btn_sms_CalculateFilter);
                        Width: =200
                        ZIndex: =5

                Container5_1 As groupContainer.verticalAutoLayoutContainer:
                    DropShadow: =DropShadow.Semibold
                    Height: =90
                    LayoutDirection: =LayoutDirection.Vertical
                    LayoutMode: =LayoutMode.Auto
                    Visible: =If(ThisItem.ID = 1 And ThisItem.status = true,true)
                    Width: =232
                    Y: =49
                    ZIndex: =4

                    Label5_3 As label:
                        AlignInContainer: =AlignInContainer.Stretch
                        Text: ="Tháng"
                        ZIndex: =3

                    Dropdown3_3 As dropdown:
                        AlignInContainer: =AlignInContainer.Center
                        BorderColor: =RGBA(73, 113, 215, 1)
                        BorderThickness: =1
                        ChevronBackground: =RGBA(73, 113, 215, 1)
                        Default: =1
                        Height: =35
                        Items: =Sequence(12,1)
                        LayoutMinWidth: =0
                        OnChange: =Select(btn_sms_CalculateFilter);
                        OnSelect: =Select(btn_sms_CalculateFilter)
                        Width: =200
                        ZIndex: =4

                Container5_2 As groupContainer.verticalAutoLayoutContainer:
                    DropShadow: =DropShadow.Semibold
                    Height: =90
                    LayoutDirection: =LayoutDirection.Vertical
                    LayoutMode: =LayoutMode.Auto
                    Visible: |-
                        =If(
                            gblRecUser.roleID > 2 && ThisItem.ID = 2 && ThisItem.status = true, //chỉ hiện khi từ giám đốc khối trở lên
                            true,
                            false
                        )
                    Width: =232
                    Y: =49
                    ZIndex: =5

                    Label5_4 As label:
                        AlignInContainer: =AlignInContainer.Stretch
                        Text: ="Phòng"
                        ZIndex: =3

                    Dropdown3_4 As dropdown:
                        AlignInContainer: =AlignInContainer.Center
                        BorderColor: =RGBA(73, 113, 215, 1)
                        BorderThickness: =1
                        ChevronBackground: =RGBA(73, 113, 215, 1)
                        Height: =35
                        Items: |-
                            =If(
                                gblRecUser.roleID = 3,
                                Filter(gblColDepartment, divisionID = gblRecUser.divisionID, active = 1),
                                If(
                                    gblRecUser.roleID = 4 || gblRecUser.roleID = 5 || gblRecUser.roleID = 7,
                                    Filter(gblColDepartment, active = 1)
                                )
                            
                            )
                        LayoutMinWidth: =0
                        OnChange: =Select(btn_sms_CalculateFilter);
                        OnSelect: =Select(btn_sms_CalculateFilter);
                        Width: =200
                        ZIndex: =4

                Container5_3 As groupContainer.verticalAutoLayoutContainer:
                    DropShadow: =DropShadow.Semibold
                    Height: =90
                    LayoutDirection: =LayoutDirection.Vertical
                    LayoutMode: =LayoutMode.Auto
                    Visible: =ThisItem.ID = 0
                    Width: =232
                    Y: =47
                    ZIndex: =6

                    Label5_5 As label:
                        AlignInContainer: =AlignInContainer.Stretch
                        Text: ="Năm"
                        ZIndex: =3

                    Dropdown3_5 As dropdown:
                        AlignInContainer: =AlignInContainer.Center
                        BorderColor: =RGBA(73, 113, 215, 1)
                        BorderThickness: =1
                        ChevronBackground: =RGBA(73, 113, 215, 1)
                        Height: =35
                        Items: =Sort(Distinct(locColReportManagerTotalDayOffInYear, year), Value, SortOrder.Ascending)
                        LayoutMinWidth: =0
                        OnChange: |
                            =//Lấy dữ liệu nếu khác năm và tính toán lại
                            If(
                                !(Dropdown3_5.Selected.Value exactin locColReportYear),
                                If(
                                    gblRecUser.roleID = 4 || gblRecUser.roleID = 5 || gblRecUser.roleID = 7,    //Nếu là giám đốc, HR, trưởng HR ------------------
                                    Concurrent(
                                        ClearCollect(    
                                            locColReportManagerTotalDayOffInMonthTemp1,  //lấy 6 tháng đầu
                                            AddColumns(
                                                Filter('ASTakeLeave.TotalDayOffInMonth', year = Dropdown3_5.Selected.Value, month <= 6) As temp,
                                                "departmentID",
                                                LookUp(gblColAllUser, userID = temp.userID && active = 1).departmentID,
                                                "divisionID",
                                                LookUp(gblColAllUser, userID = temp.userID && active = 1).divisionID
                                            )
                                        ),
                                        ClearCollect(    
                                            locColReportManagerTotalDayOffInMonthTemp2,  //lấy 6 tháng sau
                                            AddColumns(
                                                Filter('ASTakeLeave.TotalDayOffInMonth', year = Dropdown3_5.Selected.Value, month >= 7) As temp,
                                                "departmentID",
                                                LookUp(gblColAllUser, userID = temp.userID && active = 1).departmentID,
                                                "divisionID",
                                                LookUp(gblColAllUser, userID = temp.userID && active = 1).divisionID
                                            )
                                        ),
                                        Collect(    //Tạo collection chứa các year dữ liệu
                                            locColReportYear,
                                            {
                                                Value: Year(Dropdown3_5.Selected.Value)
                                            }
                                        )
                                    );
                                    //Gộp 2 collection temp
                                    Collect(
                                        locColReportManagerTotalDayOffInMonth,
                                        locColReportManagerTotalDayOffInMonthTemp1,
                                        locColReportManagerTotalDayOffInMonthTemp2
                                    )  
                                );
                            
                                //Chạy lại tính toán
                                Select(btn_sms_CalculateFilter);
                            )
                        Width: =200
                        ZIndex: =4

    ctn_hs_Header_2 As groupContainer.horizontalAutoLayoutContainer:
        DropShadow: =DropShadow.None
        Height: =104
        LayoutMode: =LayoutMode.Auto
        Width: =1170
        X: =196
        ZIndex: =24

        ctn_hs_Tab_2 As groupContainer.horizontalAutoLayoutContainer:
            AlignInContainer: =AlignInContainer.SetByContainer
            DropShadow: =DropShadow.None
            Height: =101
            LayoutAlignItems: =LayoutAlignItems.Center
            LayoutGap: =5
            LayoutMinHeight: =100
            LayoutMinWidth: =250
            LayoutMode: =LayoutMode.Auto
            PaddingLeft: =35
            Width: =122
            X: =137
            ZIndex: =1

        ctn_hs_Info_2 As groupContainer.horizontalAutoLayoutContainer:
            AlignInContainer: =AlignInContainer.Start
            DropShadow: =DropShadow.None
            Fill: =RGBA(220, 228, 252, 1)
            FillPortions: =0.3
            Height: =80
            LayoutMinHeight: =100
            LayoutMinWidth: =50
            LayoutMode: =LayoutMode.Auto
            PaddingLeft: =10
            PaddingRight: =10
            RadiusBottomLeft: =20
            RadiusBottomRight: =0
            RadiusTopLeft: =0
            RadiusTopRight: =20
            ZIndex: =2

            img_hs_Avatar_3 As image:
                AlignInContainer: =AlignInContainer.Center
                Height: =50
                Image: =User().Image
                LayoutMinHeight: =50
                RadiusBottomLeft: =img_hs_Avatar_3.Height
                RadiusBottomRight: =img_hs_Avatar_3.Height
                RadiusTopLeft: =img_hs_Avatar_3.Height
                RadiusTopRight: =img_hs_Avatar_3.Height
                Width: =50
                ZIndex: =1

            ctn_hs_Info2_3 As groupContainer.verticalAutoLayoutContainer:
                DropShadow: =DropShadow.None
                LayoutDirection: =LayoutDirection.Vertical
                LayoutMinHeight: =0
                LayoutMinWidth: =0
                LayoutMode: =LayoutMode.Auto
                PaddingLeft: =5
                ZIndex: =2

                lbl_hs_Name_3 As label:
                    FontWeight: =FontWeight.Bold
                    PaddingTop: =20
                    Size: =12
                    Text: =User().FullName
                    Wrap: =false
                    ZIndex: =1

                lbl_hs_Mail_3 As label:
                    PaddingBottom: =20
                    Size: =12
                    Text: =User().Email
                    Wrap: =false
                    ZIndex: =2

    ctn_ss_Export As groupContainer.manualLayoutContainer:
        Fill: =RGBA(0, 0, 0, 0.5)
        Height: =768
        RadiusBottomLeft: =20
        RadiusBottomRight: =20
        RadiusTopLeft: =20
        RadiusTopRight: =20
        Visible: =locExport
        Width: =1366
        ZIndex: =25

        btn_ds_BackGround_4 As button:
            BorderStyle: =BorderStyle.None
            DisabledFill: =RGBA(255, 255, 255, 1)
            DisplayMode: =DisplayMode.Disabled
            Height: =267
            RadiusBottomLeft: =5
            RadiusBottomRight: =5
            RadiusTopLeft: =5
            RadiusTopRight: =5
            Text: =""
            Width: =608
            X: =375
            Y: =260
            ZIndex: =1

        lbl_ds_Title_11 As label:
            FontWeight: =FontWeight.Bold
            Text: ="Xuất file"
            X: =387
            Y: =267
            ZIndex: =2

        shp_ds_Deco_14 As rectangle:
            Fill: =RGBA(202, 202, 202, 1)
            Height: =1
            Width: =608
            X: =375
            Y: =312
            ZIndex: =3

        ico_ds_Cancel_4 As icon.Cancel:
            Color: =RGBA(149, 149, 149, 1)
            Height: =29
            Icon: =Icon.Cancel
            OnSelect: |-
                =UpdateContext({locExport:false})
            Width: =25
            X: =942
            Y: =269
            ZIndex: =4

        lbl_ds_DepartmentName_5 As label:
            FontWeight: =FontWeight.Semibold
            Text: ="Bạn muốn xuất file tất cả nhân viên hay theo biểu đồ bộ lọc hiện tại ?"
            Width: =596
            X: =387
            Y: =320
            ZIndex: =5

        shp_ds_Deco_4 As rectangle:
            Fill: =RGBA(202, 202, 202, 1)
            Height: =1
            Width: =608
            X: =375
            Y: =467
            ZIndex: =6

        btn_ds_Submit_6 As button:
            BorderThickness: =1
            Fill: =RGBA(0, 89, 204, 1)
            Height: =36
            HoverFill: =ColorFade(Self.Fill, -20%)
            OnSelect: |-
                =Select(btn_sms_ExportFile);
                Notify("Xuất file thành công",NotificationType.Success,1500);
                UpdateContext({locExport:false})
            PressedColor: =RGBA(255,255,255,1)
            PressedFill: =Self.Fill
            RadiusBottomLeft: =5
            RadiusBottomRight: =5
            RadiusTopLeft: =5
            RadiusTopRight: =5
            Text: ="OK"
            Width: =87
            X: =879
            Y: =478
            ZIndex: =7

        btn_ds_Cancel_6 As button:
            BorderThickness: =1
            Color: =RGBA(0, 0, 0, 1)
            Fill: =RGBA(255, 255, 255, 1)
            Height: =36
            HoverFill: =ColorFade(Self.Fill, -20%)
            OnSelect: |-
                =UpdateContext({locExport:false})
            PressedColor: =RGBA(0,0,0,1)
            PressedFill: =Self.Fill
            RadiusBottomLeft: =5
            RadiusBottomRight: =5
            RadiusTopLeft: =5
            RadiusTopRight: =5
            Text: ="Hủy"
            Width: =87
            X: =781
            Y: =478
            ZIndex: =8

        Radio1 As radio:
            BorderStyle: =BorderStyle.None
            Height: =106
            Items: =locColReportExportRadio
            Width: =608
            X: =375
            Y: =354
            ZIndex: =9

    ctn_sms_CodeButton As groupContainer.manualLayoutContainer:
        Visible: =false
        X: =40
        Y: =40
        ZIndex: =26

        btn_sms_CreateReportCollection As button:
            Text: ="Button"
            X: =40
            Y: =40
            ZIndex: =1

        btn_sms_CalculateFilter As button:
            OnSelect: |
                =//Update các biến filter
                UpdateContext({locBoolReportManagerFilterTotalStatus: LookUp(locColReportManagerFilterAdvance, ID = 1).status});
                UpdateContext({locBoolReportManagerFilterDepartmentStatus: LookUp(locColReportManagerFilterAdvance, ID = 2).status});
                UpdateContext({locBoolReportManagerFilterPersonalStatus: LookUp(locColReportManagerFilterAdvance, ID = 3).status});
                
                //Tính tổng các ngày phép theo filter và theo role
                    If(
                        locBoolReportManagerFilterTotalStatus || locBoolReportManagerFilterPersonalStatus, //Đang filter tất cả nhân viên hoặc cá nhân
                        ClearCollect(
                            locColManagerReportDataMonth,
                            Filter(
                                ShowColumns(
                                    locColReportManagerTotalDayOffInMonth, 
                                    "userID", "email", "totalDayOff_Month", "totalDayUnpaid_Month", "month", "year", "departmentID", "divisionID"
                                ), 
                                year = Dropdown3_5.Selected.Value,                  //year 
                                month = If(                                         //month, nếu filter tất cả đang bật, lấy month tương ứng và ngược lại
                                            locBoolReportManagerFilterTotalStatus, 
                                            Dropdown3_3.Selected.Value, 
                                            Dropdown3_1.Selected.Value
                                        ),
                                If(locBoolReportManagerFilterDepartmentStatus, departmentID = Dropdown3_4.Selected.ID, true),   //nếu là role gd khối trở lên
                                If(locBoolReportManagerFilterPersonalStatus, email = cbb_sms_User.Selected.Email, true) //Filter cá nhân nếu đang bật
                            )
                        );
                        ClearCollect(
                            locColManagerReportStat,
                            {
                                month: Max(locColManagerReportDataMonth, month),
                                dayOffSum: Sum(locColManagerReportDataMonth, totalDayOff_Month),
                                dayOffUnPaidSum: Sum(locColManagerReportDataMonth, totalDayUnpaid_Month)
                            }
                        ),
                
                        ClearCollect(
                            locColManagerReportDataYear,
                            Filter(
                                ShowColumns(
                                    locColReportManagerTotalDayOffInMonth, 
                                    "userID", "email", "totalDayOff_Month", "totalDayUnpaid_Month", "month", "year", "departmentID", "divisionID"
                                ), 
                                year = Dropdown3_5.Selected.Value,
                                If(locBoolReportManagerFilterDepartmentStatus, departmentID = Dropdown3_4.Selected.ID, true)
                            )
                        );
                        ClearCollect(
                            locColManagerReportStat,
                            ForAll(
                                Sequence(12, 1) As temp,
                                {
                                    month: temp.Value,
                                    dayOffSum: Sum(Filter(locColManagerReportDataYear, month = temp.Value), totalDayOff_Month),
                                    dayOffUnPaidSum: Sum(Filter(locColManagerReportDataYear, month = temp.Value), totalDayUnpaid_Month)
                                }
                            )
                        )
                       
                    )
            Text: ="Button"
            X: =40
            Y: =40
            ZIndex: =2

        btn_sms_ExportFile As button:
            OnSelect: |-
                =//Xuất file theo lựa chọn của Radio button
                If(
                    Radio1.Selected.ID = 1, //Xuất theo lọc của biểu đồ tại
                    If(
                        locBoolReportManagerFilterTotalStatus || locBoolReportManagerFilterPersonalStatus, //Đang filter tất cả nhân viên hoặc cá nhân
                        Clear(locColReportExportDataMonthFilter);  //Tạo lại data export
                        ForAll(
                            locColManagerReportDataMonth As temp,
                            Collect(
                                locColReportExportDataMonthFilter,
                                temp,
                                {   
                                    name: LookUp(gblColAllUser, userID = temp.userID).fullName,
                                    jobTitle: LookUp(gblColAllUser, userID = temp.userID).jobTitle,
                                    division: LookUp(gblColDivision, ID = temp.divisionID).name,
                                    department: LookUp(gblColDepartment, ID = temp.departmentID).name
                                }
                            )
                        );
                        //Export bằng flow
                        Launch('ASTakeLeave.ExportReportFile'.Run(
                            $"TongHopNgayNghi_Thang{
                                                    If(                                  
                                                        locBoolReportManagerFilterTotalStatus, 
                                                        Dropdown3_3.Selected.Value, 
                                                        Dropdown3_1.Selected.Value
                                                        )}_{Year(Dropdown3_5.Selected.Value)}_{Hour(Now())}{Minute(Now())}{Second(Now()
                                                    )
                                                    }.csv",
                            JSON(locColReportExportDataMonthFilter, JSONFormat.IncludeBinaryData),
                            1
                        ).link & "?download=1"),
                
                        //Nếu là filter theo năm
                        Clear(locColReportExportDataYear);  //Tạo lại data export
                        ClearCollect(
                            locColReportExportDataYear,
                            AddColumns(
                                ShowColumns(
                                    Filter(
                                        locColReportManagerTotalDayOffInYear, 
                                        year = Dropdown3_5.Selected.Value,
                                        If(locBoolReportManagerFilterDepartmentStatus, departmentID = Dropdown3_4.Selected.ID, true)
                                    ),
                                    "userID", "email", "totalDayOff_Year", "totalDayUnpaid_Year", "maxDayOff_Year", "totalDayLeft_Year", "year", "departmentID", "divisionID"
                                ) As temp,
                                "name", LookUp(gblColAllUser, userID = temp.userID).fullName,
                                "jobTitle", LookUp(gblColAllUser, userID = temp.userID).jobTitle,
                                "division", LookUp(gblColDivision, ID = temp.divisionID).name,
                                "department", LookUp(gblColDepartment, ID = temp.departmentID).name
                            )
                        );
                        //Export bằng flow
                        Launch('ASTakeLeave.ExportReportFile'.Run(
                            $"TongHopNgayNghi_Nam{Year(Dropdown3_5.Selected.Value)}_{Hour(Now())}{Minute(Now())}{Second(Now())}.csv",
                            JSON(locColReportExportDataYear, JSONFormat.IncludeBinaryData),
                            2
                        ).link & "?download=1")
                    ),
                
                    Clear(locColReportExportDataYear);  //Tạo lại data export
                    //Xuất tất cả trong năm hiện tại
                    ClearCollect(
                            locColReportExportDataYear,
                            AddColumns(
                                ShowColumns(
                                    Filter(locColReportManagerTotalDayOffInYear, year = Year(Today())),
                                    "userID", "email", "totalDayOff_Year", "totalDayUnpaid_Year", "maxDayOff_Year", "totalDayLeft_Year", "year", "departmentID", "divisionID"
                                ) As temp,
                                "name", LookUp(gblColAllUser, userID = temp.userID).fullName,
                                "jobTitle", LookUp(gblColAllUser, userID = temp.userID).jobTitle,
                                "division", LookUp(gblColDivision, ID = temp.divisionID).name,
                                "department", LookUp(gblColDepartment, ID = temp.departmentID).name
                            )
                        );
                        //Export bằng flow
                        Launch('ASTakeLeave.ExportReportFile'.Run(
                            $"TongHopNgayNghi_Nam{Year(Today())}_{Hour(Now())}{Minute(Now())}{Second(Now())}.csv",
                            JSON(locColReportExportDataYear, JSONFormat.IncludeBinaryData),
                            2
                        ).link & "?download=1")
                );
                
                
                /*
                //Sửa lại các tên cột
                    ClearCollect(
                        locColReportExportAllFormatted,
                        RenameColumns(
                            ShowColumns(locColReportExportDataAll, "userID", "name", "jobTitle", "division", "department", "year", "maxDayOff_Year", "totalDayOff_Year", "totalDayUnpaid_Year", "totalDayLeft_Year"),
                            "userID", "Mã nhân viên",
                            "name", "Họ & Tên",
                            "jobTitle", "Chức danh",
                            "division", "Khối",
                            "department", "Phòng",
                            "maxDayOff_Year", "Tổng phép",
                            "totalDayOff_Year", "Đã dùng",
                            "totalDayUnpaid_Year", "Không lương",
                            "totalDayLeft_Year", "Còn lại"
                        )
                    )
                */
            Text: ="Button"
            X: =40
            Y: =40
            ZIndex: =3

